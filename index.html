import React, { useState, useEffect, useMemo } from 'react';
import { 
  Users, Briefcase, FileText, Target, Calendar, 
  Building2, IndianRupee, Megaphone, Settings, 
  Plus, Search, ExternalLink, Mail, MessageSquare, 
  Copy, Check, X, ChevronLeft, Menu, Loader2,
  Lock, LogOut, Phone, Video, MapPin, Eye, Send, Upload, Share2,
  Filter, ChevronDown, PieChart, Info, Download, BriefcaseBusiness, Globe, Tag, Clock
} from 'lucide-react';

// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVP4wCeKX1eTNXzNog0XFJfiWVpkwsrVMSmR6OtiFd238ZVwUckF-pd4SNuvmlmHX2/exec";
const GEMINI_KEY = "AIzaSyC3C8sH8yAg-Zo0_rykVUGq38i7KjHRJgA";
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;

// --- ODOO THEME CONSTANTS ---
const COLORS = {
  primary: "#714B67", // Odoo Purple
  secondary: "#00A09D", // Odoo Teal
  bg: "#F0F2F5",
  card: "#FFFFFF",
  text: "#333333",
  border: "#D1D5DB"
};

const App = () => {
  // --- STATE ---
  const [user, setUser] = useState(null);
  const [view, setView] = useState('careers'); 
  const [data, setData] = useState({
    jobs: [], applications: [], sourced: [], interviews: [], clients: [], billing: [], users: []
  });
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalType, setModalType] = useState(null);
  const [selectedItem, setSelectedItem] = useState(null);
  const [loginForm, setLoginForm] = useState({ email: '', password: '' });

  // --- AUTH LOGIC ---
  const handleLogin = (e) => {
    e.preventDefault();
    if (loginForm.email === 'rajesh@raveone.in' && loginForm.password === 'P1@st15s!') {
      setUser({ name: 'Rajesh K Rao', email: loginForm.email, role: 'Admin' });
      setView('jobs');
    } else {
      alert("Invalid credentials. Please use rajesh@raveone.in / P1@st15s!");
    }
  };

  const handleLogout = () => {
    setUser(null);
    setView('careers');
  };

  // --- DATA FETCHING ---
  const fetchData = async () => {
    setLoading(true);
    try {
      const sheets = ['Jobs', 'Applications', 'Sourced', 'Interview Tracker', 'Clients', 'Dashboard and Billing', 'Users'];
      const results = await Promise.all(
        sheets.map(s => fetch(`${SCRIPT_URL}?action=getSheetData&sheetName=${encodeURIComponent(s)}`).then(r => r.json()))
      );
      setData({
        jobs: results[0] || [],
        applications: results[1] || [],
        sourced: results[2] || [],
        interviews: results[3] || [],
        clients: results[4] || [],
        billing: results[5] || [],
        users: results[6] || []
      });
    } catch (err) {
      console.error("Database connection failed:", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // --- BACKEND UPDATES ---
  const postAction = async (payload) => {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (result.success) {
        fetchData();
        setIsModalOpen(false);
      } else {
        alert("Error: " + result.error);
      }
    } catch (err) {
      alert("Network Error: Could not connect to Raveone Backend.");
    }
  };

  // --- GEMINI AI INTEGRATION ---
  const generateAI = async (prompt) => {
    try {
      const res = await fetch(GEMINI_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const json = await res.json();
      return json.candidates?.[0]?.content?.parts?.[0]?.text || "Generation failed.";
    } catch (err) {
      return "AI connection error.";
    }
  };

  // --- GOOGLE JOBS SCHEMA (SEO) ---
  const injectSchema = (job) => {
    const schema = {
      "@context": "https://schema.org/",
      "@type": "JobPosting",
      "title": job.title,
      "description": job.description,
      "identifier": { "@type": "PropertyValue", "name": job.company, "value": job.jobid },
      "datePosted": job.posteddate,
      "validThrough": "2026-12-31",
      "employmentType": job.employmenttype?.toUpperCase().replace(" ", "_") || "FULL_TIME",
      "hiringOrganization": { "@type": "Organization", "name": job.company, "sameAs": "https://raveone.in" },
      "jobLocation": { "@type": "Place", "address": { "@type": "PostalAddress", "addressLocality": job.location, "addressRegion": "KA", "addressCountry": "IN" } },
      "baseSalary": { "@type": "MonetaryAmount", "currency": "INR", "value": { "@type": "QuantitativeValue", "minValue": job.minsalary, "maxValue": job.maxsalary, "unitText": "MONTH" } }
    };
    let script = document.getElementById('job-schema');
    if (script) script.remove();
    script = document.createElement('script');
    script.id = 'job-schema';
    script.type = 'application/ld+json';
    script.text = JSON.stringify(schema);
    document.head.appendChild(script);
  };

  // --- SHARED UI COMPONENTS ---
  const NavButton = ({ id, label, icon: Icon }) => (
    <button
      onClick={() => setView(id)}
      className={`h-full px-5 flex items-center gap-2 text-sm font-bold border-b-4 transition-all ${
        view === id 
        ? "border-[#00A09D] text-[#00A09D] bg-white/5" 
        : "border-transparent text-white/70 hover:text-white hover:bg-white/10"
      }`}
    >
      <Icon size={16} /> {label}
    </button>
  );

  const Table = ({ headers, rows, renderRow }) => (
    <div className="bg-white border border-gray-200 rounded-sm shadow-sm overflow-x-auto">
      <table className="w-full text-left border-collapse text-[13px]">
        <thead className="bg-gray-50 border-b">
          <tr>
            {headers.map((h, i) => (
              <th key={i} className="px-4 py-3 font-black text-gray-500 uppercase tracking-tight">{h}</th>
            ))}
          </tr>
        </thead>
        <tbody className="divide-y divide-gray-100">
          {rows.length > 0 ? rows.map((r, i) => renderRow(r, i)) : (
            <tr><td colSpan={headers.length} className="p-12 text-center text-gray-400 italic">No records found in database</td></tr>
          )}
        </tbody>
      </table>
    </div>
  );

  const OdooCard = ({ title, children, action, className = "" }) => (
    <div className={`bg-white border border-gray-200 rounded-sm shadow-sm flex flex-col ${className}`}>
      {(title || action) && (
        <div className="px-5 py-3 border-b bg-gray-50 flex justify-between items-center">
          <h3 className="font-bold text-[#714B67] text-xs uppercase tracking-widest">{title}</h3>
          {action}
        </div>
      )}
      <div className="p-5 flex-1">{children}</div>
    </div>
  );

  // --- VIEW: CAREERS (PUBLIC) ---
  const CareersPage = () => {
    const [subView, setSubView] = useState('list');
    const [selectedJob, setSelectedJob] = useState(null);
    const [applyForm, setApplyForm] = useState({
      candidatename: '', email: '', phone: '', education: '', 
      totalexperience: '', relevantexperience: '', currentctc: '', 
      expectedctc: '', noticeperiod: '', location: '', resumelink: ''
    });

    if (subView === 'detail' && selectedJob) {
      return (
        <div className="max-w-5xl mx-auto space-y-6 pb-20 animate-in fade-in">
          <button onClick={() => setSubView('list')} className="flex items-center gap-1 text-[#714B67] font-black hover:underline mb-4">
            <ChevronLeft size={18} /> BACK TO OPENINGS
          </button>
          
          <OdooCard>
            <div className="flex flex-col md:flex-row justify-between items-start gap-6 mb-8 border-b pb-8">
              <div className="space-y-2">
                <div className="flex gap-2">
                  <span className="bg-purple-50 text-[#714B67] px-2 py-1 rounded text-[10px] font-black tracking-widest uppercase">{selectedJob.jobid}</span>
                  <span className="bg-teal-50 text-[#00A09D] px-2 py-1 rounded text-[10px] font-black tracking-widest uppercase">{selectedJob.category}</span>
                </div>
                <h1 className="text-4xl font-black text-gray-800 leading-tight">{selectedJob.title}</h1>
                <p className="text-gray-500 font-bold flex items-center gap-4">
                  <span className="flex items-center gap-1"><Building2 size={16}/> {selectedJob.company}</span>
                  <span className="flex items-center gap-1"><MapPin size={16}/> {selectedJob.location}</span>
                  <span className="flex items-center gap-1 text-[10px] text-gray-400 font-medium">POSTED ON: {selectedJob.posteddate}</span>
                </p>
              </div>
              <button onClick={() => setSubView('apply')} className="bg-[#00A09D] text-white px-10 py-4 font-black rounded-sm shadow-xl hover:brightness-110 uppercase text-sm tracking-widest">APPLY FOR THIS ROLE</button>
            </div>
            
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-10">
              <div className="lg:col-span-2 space-y-10">
                <section>
                  <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><Info size={14}/> Role Description</h4>
                  <div className="text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">{selectedJob.description}</div>
                </section>
                <section>
                  <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><Tag size={14}/> Key Requirements</h4>
                  <div className="text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">{selectedJob.requirements}</div>
                </section>
                {selectedJob.benefits && (
                  <section>
                    <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><IndianRupee size={14}/> Employee Benefits</h4>
                    <div className="text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">{selectedJob.benefits}</div>
                  </section>
                )}
                {selectedJob.skills && (
                  <section>
                    <h4 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><Target size={14}/> Required Skills</h4>
                    <div className="flex flex-wrap gap-2">
                      {selectedJob.skills.split(',').map((skill, i) => (
                        <span key={i} className="bg-gray-100 px-3 py-1 text-xs font-bold text-gray-600 rounded-full">{skill.trim()}</span>
                      ))}
                    </div>
                  </section>
                )}
              </div>
              <div className="space-y-6">
                <OdooCard title="Role Intelligence" className="bg-gray-50 border-none">
                  <div className="space-y-5">
                    <div><p className="text-[10px] font-bold text-gray-400 uppercase mb-1">Industry Sector</p><p className="font-bold text-sm">{selectedJob.industry || "General"}</p></div>
                    <div><p className="text-[10px] font-bold text-gray-400 uppercase mb-1">Career Bracket</p><p className="font-bold text-sm">{selectedJob.minexperience} - {selectedJob.maxexperience} Years</p></div>
                    <div><p className="text-[10px] font-bold text-gray-400 uppercase mb-1">Budget Allocation</p><p className="font-bold text-sm text-[#00A09D]">₹ {selectedJob.minsalary} - {selectedJob.maxsalary}</p></div>
                    <div><p className="text-[10px] font-bold text-gray-400 uppercase mb-1">Academic Requirement</p><p className="font-bold text-sm">{selectedJob.education}</p></div>
                    <div><p className="text-[10px] font-bold text-gray-400 uppercase mb-1">Employment Type</p><p className="font-bold text-sm uppercase">{selectedJob.employmenttype}</p></div>
                    <div><p className="text-[10px] font-bold text-gray-400 uppercase mb-1">Available Headcount</p><p className="font-bold text-sm">{selectedJob.numberofpositions} Opening(s)</p></div>
                    <div className="pt-4 border-t border-gray-200">
                       <a href={selectedJob.joburl} target="_blank" rel="noreferrer" className="text-[10px] font-black text-[#714B67] uppercase underline flex items-center gap-1 hover:text-[#00A09D]"><Globe size={12}/> Original Listing Link</a>
                    </div>
                  </div>
                </OdooCard>
              </div>
            </div>
          </OdooCard>
        </div>
      );
    }

    if (subView === 'apply' && selectedJob) {
      return (
        <div className="max-w-4xl mx-auto pb-20 animate-in slide-in-from-bottom-5">
          <button onClick={() => setSubView('detail')} className="flex items-center gap-1 text-[#714B67] font-black mb-4 uppercase text-xs">
            <ChevronLeft size={16} /> RETURN TO JD
          </button>
          <OdooCard title={`Talent Submission: ${selectedJob.title}`}>
            <form className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" onSubmit={e => {
              e.preventDefault();
              const appId = `APP-${Date.now().toString().slice(-6)}`;
              const finalApp = { 
                ...applyForm, 
                appid: appId,
                jobid: selectedJob.jobid, 
                jobtitle: selectedJob.title, 
                status: 'New', 
                applieddate: new Date().toISOString().split('T')[0] 
              };
              postAction({ action: 'addApplication', application: finalApp });
            }}>
              {/* FIELD 1-3 */}
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Full Name</label>
                <input required placeholder="Candidate Name" value={applyForm.candidatename} onChange={e=>setApplyForm({...applyForm, candidatename: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Primary Email</label>
                <input required type="email" placeholder="email@address.com" value={applyForm.email} onChange={e=>setApplyForm({...applyForm, email: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Contact Number</label>
                <input required placeholder="+91 0000000000" value={applyForm.phone} onChange={e=>setApplyForm({...applyForm, phone: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              
              {/* FIELD 4-6 */}
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Qualification</label>
                <input required placeholder="Highest Degree" value={applyForm.education} onChange={e=>setApplyForm({...applyForm, education: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Total Experience (Yrs)</label>
                <input required placeholder="e.g. 5" value={applyForm.totalexperience} onChange={e=>setApplyForm({...applyForm, totalexperience: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Relevant Experience</label>
                <input required placeholder="e.g. 3" value={applyForm.relevantexperience} onChange={e=>setApplyForm({...applyForm, relevantexperience: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>

              {/* FIELD 7-9 */}
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Current CTC</label>
                <input required placeholder="e.g. 8 LPA" value={applyForm.currentctc} onChange={e=>setApplyForm({...applyForm, currentctc: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Expected CTC</label>
                <input required placeholder="e.g. 12 LPA" value={applyForm.expectedctc} onChange={e=>setApplyForm({...applyForm, expectedctc: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              <div className="col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Notice Period</label>
                <input required placeholder="e.g. 30 Days" value={applyForm.noticeperiod} onChange={e=>setApplyForm({...applyForm, noticeperiod: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>

              <div className="col-span-1 lg:col-span-1">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Candidate Location</label>
                <input required placeholder="Current City" value={applyForm.location} onChange={e=>setApplyForm({...applyForm, location: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>

              <div className="col-span-1 lg:col-span-2">
                <label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Resume URL / Cloud Link</label>
                <input required placeholder="Google Drive, Dropbox, or OneDrive link" value={applyForm.resumelink} onChange={e=>setApplyForm({...applyForm, resumelink: e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" />
              </div>
              
              <div className="col-span-1 lg:col-span-3 py-6 border-y border-dashed border-gray-200">
                <div className="flex flex-col items-center justify-center p-12 bg-gray-50 border-2 border-dashed border-gray-300 rounded-sm hover:bg-white transition-all cursor-pointer group">
                  <Upload size={40} className="text-[#714B67] mb-3 group-hover:scale-110 transition-transform" />
                  <p className="text-xs font-black text-[#714B67] uppercase mb-1 tracking-widest">Upload Digital Resume</p>
                  <p className="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">Native PDF or Docx (Sync to Google Cloud)</p>
                  <input type="file" id="cv-upload-input" className="hidden" />
                  <label htmlFor="cv-upload-input" className="mt-6 px-8 py-3 bg-[#714B67] text-white text-[11px] font-black rounded-sm cursor-pointer shadow-2xl hover:brightness-110 tracking-widest">SELECT CV FILE</label>
                </div>
              </div>

              <div className="col-span-1 lg:col-span-3 pt-6">
                <button type="submit" className="w-full bg-[#714B67] text-white py-5 font-black rounded-sm shadow-2xl uppercase text-sm tracking-[0.3em] hover:brightness-110 transition-all flex items-center justify-center gap-3">
                  <Send size={18}/> FINAL SUBMISSION
                </button>
                <p className="text-[9px] text-gray-400 text-center mt-4 font-bold uppercase tracking-widest italic">Validated through Raveone Consultants ATS Security Layer</p>
              </div>
            </form>
          </OdooCard>
        </div>
      );
    }

    return (
      <div className="max-w-7xl mx-auto space-y-16">
        <div className="text-center py-16 space-y-4">
          <div className="inline-block bg-[#714B67]/10 px-4 py-1 rounded-full"><p className="text-[10px] font-black text-[#714B67] uppercase tracking-[0.3em]">Talent Ecosystem</p></div>
          <h1 className="text-7xl font-black text-[#714B67] uppercase italic tracking-tighter leading-none mb-3">Careers @ Raveone</h1>
          <p className="text-gray-400 font-bold uppercase text-xs tracking-[0.5em] opacity-60">Architecting Careers. Scaling Enterprises.</p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
          {data.jobs.filter(j => String(j.status).toLowerCase() === 'active').map(job => (
            <div key={job.jobid} className="bg-white border-l-8 border-transparent hover:border-[#714B67] p-10 rounded-sm shadow-xl transition-all cursor-pointer group flex flex-col h-full hover:-translate-y-2" onClick={() => { setSelectedJob(job); injectSchema(job); setSubView('detail'); }}>
              <div className="flex justify-between items-start mb-8">
                <div className="flex flex-col gap-1">
                   <span className="text-[10px] font-black text-[#00A09D] uppercase tracking-widest">{job.category}</span>
                   <span className="text-[9px] font-black text-gray-300 uppercase tracking-widest">{job.jobid}</span>
                </div>
                <div className="bg-gray-50 p-2 rounded"><Clock size={12} className="text-gray-300" /></div>
              </div>
              <h3 className="text-2xl font-black text-gray-800 group-hover:text-[#714B67] mb-3 leading-none tracking-tight flex-1">{job.title}</h3>
              <div className="space-y-4 mb-8">
                <p className="text-xs text-gray-500 font-bold uppercase tracking-tight flex items-center gap-2"><Building2 size={14} className="text-gray-300"/> {job.company}</p>
                <p className="text-xs text-gray-500 font-bold uppercase tracking-tight flex items-center gap-2"><MapPin size={14} className="text-gray-300"/> {job.location}</p>
              </div>
              
              <div className="pt-8 border-t border-gray-100 flex justify-between items-center mt-auto">
                <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">{job.minexperience}+ Yrs Required</span>
                <div className="w-8 h-8 bg-gray-50 rounded-full flex items-center justify-center group-hover:bg-[#714B67] transition-all">
                  <ChevronLeft size={16} className="text-gray-300 group-hover:text-white rotate-180" />
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  // --- RECRUITER LOGIN OVERLAY ---
  if (!user && view === 'login') {
    return (
      <div className="min-h-screen bg-[#F0F2F5] flex items-center justify-center p-4">
        <div className="w-full max-w-sm bg-white p-10 rounded-sm shadow-2xl border-t-8 border-[#714B67] animate-in zoom-in-95 duration-300">
          <div className="text-center mb-10">
            <h1 className="text-3xl font-black text-[#714B67] italic tracking-tighter">RECRUITER LOGIN</h1>
            <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mt-2">Access Secure ATS Database</p>
          </div>
          <form className="space-y-6" onSubmit={handleLogin}>
            <div>
              <label className="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-2">Email Identity</label>
              <div className="relative">
                <Mail className="absolute left-3 top-2.5 text-gray-300" size={16} />
                <input required type="email" placeholder="rajesh@raveone.in" className="w-full border-b-2 border-gray-100 pl-10 pr-4 py-2 text-sm outline-none focus:border-[#714B67] transition-colors" value={loginForm.email} onChange={e=>setLoginForm({...loginForm, email:e.target.value})} />
              </div>
            </div>
            <div>
              <label className="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-2">Access Token</label>
              <div className="relative">
                <Lock className="absolute left-3 top-2.5 text-gray-300" size={16} />
                <input required type="password" placeholder="••••••••" className="w-full border-b-2 border-gray-100 pl-10 pr-4 py-2 text-sm outline-none focus:border-[#714B67] transition-colors" value={loginForm.password} onChange={e=>setLoginForm({...loginForm, password:e.target.value})} />
              </div>
            </div>
            <button className="w-full bg-[#714B67] text-white py-4 font-black text-sm rounded-sm shadow-xl hover:brightness-110 transition-all uppercase tracking-widest">Sign In</button>
            <button type="button" onClick={() => setView('careers')} className="w-full text-gray-400 text-xs font-bold hover:text-[#714B67] mt-4">Return to Public Portal</button>
          </form>
        </div>
      </div>
    );
  }

  // --- MODULE: JOBS (ADMIN) ---
  const JobsModule = () => {
    const [isGenerating, setIsGenerating] = useState(false);
    const handleAdd = () => { setSelectedItem({ status: 'Active', jobid: `J${Math.floor(Math.random()*900)+100}`, posteddate: new Date().toISOString().split('T')[0] }); setModalType('job'); setIsModalOpen(true); };
    
    const shareJob = (job, mode) => {
      const msg = `*Raveone Hiring Alert: ${job.title}*\nCompany: ${job.company}\nLocation: ${job.location}\nExp: ${job.minexperience}-${job.maxexperience}\nApply Link: https://raveone.in/careers?jobid=${job.jobid}\n\nRegards,\nRaveone Consultants`;
      if (mode === 'WA') window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
      else { navigator.clipboard.writeText(msg); alert("Job sharing content copied to clipboard!"); }
    };

    return (
      <div className="space-y-8">
        <div className="flex justify-between items-center px-2">
          <div>
            <h2 className="text-2xl font-black text-[#714B67] leading-none uppercase tracking-tight">Job Inventory</h2>
            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-2">Manage all active requirements</p>
          </div>
          <button onClick={handleAdd} className="bg-[#714B67] text-white px-6 py-3 text-xs font-black flex items-center gap-2 rounded-sm shadow-xl uppercase tracking-widest"><Plus size={18}/> New Requirement</button>
        </div>
        
        <Table headers={["ID", "Position", "Client Account", "Location", "Status", "Actions"]} rows={data.jobs} renderRow={j => (
          <tr key={j.jobid} className="hover:bg-gray-50 transition-colors">
            <td className="px-4 py-4 font-black text-gray-400">{j.jobid}</td>
            <td className="px-4 py-4 font-black text-gray-800">{j.title}</td>
            <td className="px-4 py-4 text-gray-500 font-bold uppercase">{j.company}</td>
            <td className="px-4 py-4 text-gray-500 font-medium">{j.location}</td>
            <td className="px-4 py-4">
              <span className={`px-2 py-1 rounded-sm font-black text-[9px] uppercase ${j.status==='Active' ? 'bg-green-100 text-green-700':'bg-gray-100 text-gray-400'}`}>
                {j.status}
              </span>
            </td>
            <td className="px-4 py-4 flex gap-4">
              <button onClick={() => {setSelectedItem(j); setModalType('job'); setIsModalOpen(true);}} className="text-[#00A09D] font-black uppercase text-[11px] hover:underline">Edit</button>
              <button onClick={() => shareJob(j, 'WA')} className="text-green-600 hover:scale-110 transition-transform"><MessageSquare size={16}/></button>
              <button onClick={() => shareJob(j, 'Email')} className="text-purple-600 hover:scale-110 transition-transform"><Mail size={16}/></button>
            </td>
          </tr>
        )} />

        {isModalOpen && modalType === 'job' && (
          <div className="fixed inset-0 bg-black/60 z-[200] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-6xl rounded-sm shadow-2xl flex flex-col max-h-[95vh] overflow-hidden">
              <div className="p-5 border-b bg-gray-50 flex justify-between items-center">
                <h3 className="font-black text-[#714B67] uppercase text-sm tracking-widest">Update Job Profile: {selectedItem.jobid}</h3>
                <button onClick={()=>setIsModalOpen(false)} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
              </div>
              <div className="p-8 overflow-y-auto grid grid-cols-1 md:grid-cols-3 gap-10">
                <div className="md:col-span-2 space-y-6">
                  <div className="grid grid-cols-2 gap-6">
                    <div><label className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Role Title</label><input value={selectedItem.title||''} onChange={e=>setSelectedItem({...selectedItem, title:e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" /></div>
                    <div><label className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Client Account</label><input value={selectedItem.company||''} onChange={e=>setSelectedItem({...selectedItem, company:e.target.value})} className="w-full border p-2 text-sm outline-none focus:border-[#714B67]" /></div>
                  </div>
                  <div>
                    <div className="flex justify-between items-center mb-1">
                      <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">JD Description</label>
                      <button onClick={async ()=>{ setIsGenerating(true); const ai = await generateAI(`Professional JD for ${selectedItem.title} at ${selectedItem.company}`); setSelectedItem({...selectedItem, description: ai}); setIsGenerating(false); }} className="text-[9px] font-black text-[#00A09D] underline flex items-center gap-1">
                        {isGenerating ? <Loader2 size={10} className="animate-spin" /> : <Megaphone size={10}/>} AI AUTO-GENERATE
                      </button>
                    </div>
                    <textarea value={selectedItem.description||''} onChange={e=>setSelectedItem({...selectedItem, description:e.target.value})} className="w-full border p-3 text-xs h-40 outline-none leading-relaxed" />
                  </div>
                  <div className="grid grid-cols-2 gap-6">
                    <div><label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Key Requirements</label><textarea value={selectedItem.requirements||''} onChange={e=>setSelectedItem({...selectedItem, requirements:e.target.value})} className="w-full border p-2 text-xs h-32 outline-none" /></div>
                    <div><label className="text-[10px] font-black text-gray-400 uppercase mb-1 block">Employee Benefits</label><textarea value={selectedItem.benefits||''} onChange={e=>setSelectedItem({...selectedItem, benefits:e.target.value})} className="w-full border p-2 text-xs h-32 outline-none" /></div>
                  </div>
                </div>
                <div className="bg-gray-50 p-6 space-y-5 rounded-sm border border-gray-200 h-fit">
                   <h4 className="text-[10px] font-black text-gray-400 uppercase border-b pb-2 mb-4 tracking-tighter">Backend Metadata</h4>
                   <div><label className="text-[9px] font-black text-gray-500 uppercase">Work Location</label><input value={selectedItem.location||''} onChange={e=>setSelectedItem({...selectedItem, location:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                   <div className="grid grid-cols-2 gap-2">
                    <div><label className="text-[9px] font-black text-gray-500 uppercase">Min Exp</label><input value={selectedItem.minexperience||''} onChange={e=>setSelectedItem({...selectedItem, minexperience:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                    <div><label className="text-[9px] font-black text-gray-500 uppercase">Max Exp</label><input value={selectedItem.maxexperience||''} onChange={e=>setSelectedItem({...selectedItem, maxexperience:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                   </div>
                   <div className="grid grid-cols-2 gap-2">
                    <div><label className="text-[9px] font-black text-gray-500 uppercase">Min Salary</label><input value={selectedItem.minsalary||''} onChange={e=>setSelectedItem({...selectedItem, minsalary:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                    <div><label className="text-[9px] font-black text-gray-500 uppercase">Max Salary</label><input value={selectedItem.maxsalary||''} onChange={e=>setSelectedItem({...selectedItem, maxsalary:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                   </div>
                   <div><label className="text-[9px] font-black text-gray-500 uppercase">Industry</label><input value={selectedItem.industry||''} onChange={e=>setSelectedItem({...selectedItem, industry:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                   <div><label className="text-[9px] font-black text-gray-500 uppercase">Education Required</label><input value={selectedItem.education||''} onChange={e=>setSelectedItem({...selectedItem, education:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                   <div><label className="text-[9px] font-black text-gray-500 uppercase">Open Positions</label><input value={selectedItem.numberofpositions||''} onChange={e=>setSelectedItem({...selectedItem, numberofpositions:e.target.value})} className="w-full border p-1 text-xs outline-none" /></div>
                   <div><label className="text-[9px] font-black text-gray-500 uppercase">Job Status</label>
                    <select value={selectedItem.status||'Active'} onChange={e=>setSelectedItem({...selectedItem, status:e.target.value})} className="w-full border p-1 text-xs outline-none bg-white">
                      <option>Active</option><option>Inactive</option><option>Closed</option>
                    </select>
                   </div>
                </div>
              </div>
              <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                <button onClick={()=>setIsModalOpen(false)} className="px-6 py-2 border rounded-sm text-xs font-black uppercase tracking-widest text-gray-500 hover:bg-white transition-colors">Cancel</button>
                <button onClick={()=>postAction({action:'updateJob', job:selectedItem})} className="px-6 py-2 bg-[#714B67] text-white rounded-sm text-xs font-black shadow-xl uppercase tracking-widest hover:brightness-110">Save Record</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // --- MODULE: APPLICATIONS (ADMIN) ---
  const ApplicationsModule = () => (
    <div className="space-y-8">
      <div className="flex justify-between items-center px-2">
        <div>
          <h2 className="text-2xl font-black text-[#714B67] uppercase tracking-tight">Active Applications</h2>
          <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-2">Track applicant flow and cv screening</p>
        </div>
      </div>
      
      <Table headers={["ID", "Job Role", "Candidate Name", "Exp & Education", "CTC Details", "Status", "Actions"]} rows={data.applications} renderRow={a => (
        <tr key={a.appid} className="hover:bg-gray-50 transition-colors">
          <td className="px-4 py-4 font-black text-gray-400">{a.appid}</td>
          <td className="px-4 py-4 font-black text-[#714B67] uppercase text-[11px] leading-tight">{a.jobid}<br/><span className="text-[9px] text-gray-400 font-bold">{a.jobtitle}</span></td>
          <td className="px-4 py-4 font-black text-gray-800">{a.candidatename}</td>
          <td className="px-4 py-4">
             <div className="text-[10px] font-black text-gray-400 uppercase tracking-tighter">{a.education}</div>
             <div className="text-[11px] font-bold text-gray-600">{a.totalexperience} / {a.relevantexperience} Yrs Exp</div>
          </td>
          <td className="px-4 py-4 text-[11px] font-bold text-gray-500">{a.currentctc} → {a.expectedctc}</td>
          <td className="px-4 py-4">
            <select value={a.status||'New'} onChange={e=>postAction({action:'updateApplicationStatus', appId:a.appid, status:e.target.value})} className="border-b-2 border-transparent p-1 text-[10px] font-black uppercase outline-none focus:border-[#714B67] bg-transparent">
              <option>New</option><option>Screening</option><option>Interview</option><option>Joined</option><option>Rejected</option>
            </select>
          </td>
          <td className="px-4 py-4 flex gap-3">
            <button onClick={()=>{setSelectedItem(a); setModalType('cv'); setIsModalOpen(true);}} className="p-2 bg-blue-50 text-blue-600 rounded-sm hover:bg-blue-600 hover:text-white transition-all shadow-sm" title="View In-Portal CV"><Eye size={16}/></button>
            <button onClick={()=>{ navigator.clipboard.writeText(`Hi ${a.candidatename}, regarding your application for ${a.jobtitle}...`); alert("Candidate pitch copied for client email!"); }} className="p-2 bg-purple-50 text-purple-600 rounded-sm hover:bg-purple-600 hover:text-white transition-all shadow-sm" title="Email Pitch"><Mail size={16}/></button>
            <a href={`https://wa.me/${a.phone}`} target="_blank" className="p-2 bg-green-50 text-green-600 rounded-sm hover:bg-green-600 hover:text-white transition-all shadow-sm"><MessageSquare size={16}/></a>
          </td>
        </tr>
      )} />
      
      {isModalOpen && modalType === 'cv' && (
        <div className="fixed inset-0 bg-black/80 z-[300] flex items-center justify-center p-4 backdrop-blur-md">
          <div className="bg-white w-full max-w-6xl h-[95vh] rounded-sm flex flex-col shadow-2xl overflow-hidden animate-in zoom-in-95">
            <div className="p-4 border-b flex justify-between items-center bg-gray-50 text-xs font-black text-[#714B67] uppercase tracking-widest">
              In-Portal CV Viewer: {selectedItem.candidatename}
              <button onClick={()=>setIsModalOpen(false)} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
            </div>
            <iframe src={selectedItem.resumelink} className="flex-1 w-full border-none bg-gray-200" title="Resume Viewer" />
          </div>
        </div>
      )}
    </div>
  );

  // --- MODULE: INTERVIEWS (ADMIN) ---
  const InterviewModule = () => {
    const handleAdd = () => { setSelectedItem({ interviewid: `I${Date.now().toString().slice(-4)}`, nextstep: 'Scheduled', interviewmode: 'VC' }); setModalType('interview'); setIsModalOpen(true); };
    return (
      <div className="space-y-8">
        <div className="flex justify-between items-center px-2">
          <div>
            <h2 className="text-2xl font-black text-[#714B67] uppercase tracking-tight">Interview Pipeline</h2>
            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-2">Manage scheduled meetings and feedback</p>
          </div>
          <button onClick={handleAdd} className="bg-[#714B67] text-white px-6 py-3 text-xs font-black flex items-center gap-2 rounded-sm shadow-xl uppercase tracking-widest"><Calendar size={18}/> New Slot</button>
        </div>
        
        <Table headers={["ID", "Candidate", "Company", "Mode / Schedule", "Status", "Actions"]} rows={data.interviews} renderRow={i => {
           const candidate = data.applications.find(a => a.candidatename === i.candidatename) || {};
           const client = data.clients.find(c => c.companyname === i.companyname) || {};
           return (
            <tr key={i.interviewid} className="hover:bg-gray-50 transition-colors">
              <td className="px-4 py-4 font-black text-gray-400">{i.interviewid}</td>
              <td className="px-4 py-4 font-black text-gray-800 uppercase tracking-tight">{i.candidatename}</td>
              <td className="px-4 py-4 font-bold text-gray-500 uppercase text-[11px]">{i.companyname}</td>
              <td className="px-4 py-4">
                <div className="flex items-center gap-1 font-black text-[#714B67] text-[10px] uppercase">
                  {i.interviewmode === 'VC' ? <Video size={12}/> : i.interviewmode === 'F2F' ? <MapPin size={12}/> : <Phone size={12}/>} {i.interviewmode}
                </div>
                <div className="text-[11px] font-bold text-gray-400">{i.interviewdate} @ {i.interviewtime}</div>
              </td>
              <td className="px-4 py-4"><span className="text-[10px] font-black px-2 py-1 bg-purple-50 text-purple-700 rounded-sm uppercase">{i.nextstep}</span></td>
              <td className="px-4 py-4">
                <button onClick={() => {setSelectedItem({...i, cand_phone: candidate.phone, clnt_phone: client.phone, cand_email: candidate.email}); setModalType('interview'); setIsModalOpen(true);}} className="text-[#00A09D] font-black uppercase text-[11px] border-b-2 border-transparent hover:border-[#00A09D] transition-all">Coordinate</button>
              </td>
            </tr>
          );
        }} />

        {isModalOpen && modalType === 'interview' && (
          <div className="fixed inset-0 bg-black/60 z-[200] flex items-center justify-center p-4">
             <div className="bg-white w-full max-w-lg rounded-sm shadow-2xl overflow-hidden flex flex-col">
              <div className="p-4 border-b bg-gray-50 flex justify-between items-center text-xs font-black text-[#714B67] uppercase tracking-widest">
                Scheduling Logic: {selectedItem.interviewid}
                <button onClick={()=>setIsModalOpen(false)}><X size={20}/></button>
              </div>
              <div className="p-6 space-y-6">
                <div className="grid grid-cols-2 gap-4">
                   <div className="bg-blue-50 p-4 rounded-sm border border-blue-100">
                      <p className="text-[9px] font-black text-gray-400 uppercase mb-1">Candidate Coord</p>
                      <p className="text-sm font-black text-gray-800">{selectedItem.candidatename}</p>
                      <p className="text-[11px] text-blue-700 font-bold">{selectedItem.cand_phone || 'N/A'}</p>
                   </div>
                   <div className="bg-purple-50 p-4 rounded-sm border border-purple-100">
                      <p className="text-[9px] font-black text-gray-400 uppercase mb-1">Client Coord</p>
                      <p className="text-sm font-black text-gray-800">{selectedItem.companyname}</p>
                      <p className="text-[11px] text-purple-700 font-bold">{selectedItem.clnt_phone || 'N/A'}</p>
                   </div>
                </div>
                <div className="grid grid-cols-3 gap-3">
                  <div>
                    <label className="text-[10px] font-black text-gray-400 uppercase block mb-1">Type</label>
                    <select value={selectedItem.interviewmode} onChange={e=>setSelectedItem({...selectedItem, interviewmode:e.target.value})} className="w-full border p-2 text-xs outline-none bg-white">
                      <option value="VC">Video Call</option><option value="F2F">Face to Face</option><option value="Telephonic">Telephonic</option>
                    </select>
                  </div>
                  <div><label className="text-[10px] font-black text-gray-400 uppercase block mb-1">Date</label><input type="date" value={selectedItem.interviewdate||''} onChange={e=>setSelectedItem({...selectedItem, interviewdate:e.target.value})} className="w-full border p-2 text-xs outline-none" /></div>
                  <div><label className="text-[10px] font-black text-gray-400 uppercase block mb-1">Time</label><input type="time" value={selectedItem.interviewtime||''} onChange={e=>setSelectedItem({...selectedItem, interviewtime:e.target.value})} className="w-full border p-2 text-xs outline-none" /></div>
                </div>
                <div>
                  <label className="text-[10px] font-black text-gray-400 uppercase block mb-1">Interview Logistics (Link/Venue)</label>
                  <textarea placeholder="Meeting link or office address..." className="w-full border p-3 text-xs h-24 outline-none leading-relaxed" value={selectedItem.interviewfeedback||''} onChange={e=>setSelectedItem({...selectedItem, interviewfeedback:e.target.value})} />
                </div>
              </div>
              <div className="p-4 border-t bg-gray-50 flex justify-end gap-3">
                <button onClick={()=>setIsModalOpen(false)} className="px-5 py-2 border rounded-sm text-xs font-black uppercase tracking-widest text-gray-500 hover:bg-white transition-all">Cancel</button>
                <button onClick={()=>postAction({action:'updateInterviewStep', interview_id:selectedItem.interviewid, next_step:selectedItem.nextstep, ...selectedItem})} className="px-5 py-2 bg-[#714B67] text-white rounded-sm text-xs font-black shadow-xl uppercase tracking-widest hover:brightness-110 transition-all">Save Slot</button>
              </div>
             </div>
          </div>
        )}
      </div>
    );
  };

  // --- MODULE: CLIENTS (ADMIN) ---
  const ClientsModule = () => {
    const [drillDown, setDrillDown] = useState(null);
    return (
      <div className="space-y-8">
        <h2 className="text-2xl font-black text-[#714B67] uppercase tracking-tight">Client Hub</h2>
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
           <div className="lg:col-span-2">
              <Table headers={["ID", "Account Name", "Contact", "Jobs", "Status", "Actions"]} rows={data.clients} renderRow={c => (
                <tr key={c.clientid} className="hover:bg-gray-50 transition-colors">
                  <td className="px-4 py-4 font-black text-gray-400">{c.clientid}</td>
                  <td className="px-4 py-4 font-black text-[#714B67] uppercase text-[12px]">{c.companyname}</td>
                  <td className="px-4 py-4 text-gray-500 font-bold text-[11px]">{c.contactname}<br/>{c.email}</td>
                  <td className="px-4 py-4 font-black text-gray-400">{c.assignedjobscount}</td>
                  <td className="px-4 py-4"><span className={`px-2 py-1 rounded-sm font-black text-[9px] uppercase ${c.clientstatus==='Hot' ? 'bg-orange-100 text-orange-700':'bg-gray-100 text-gray-400'}`}>{c.clientstatus}</span></td>
                  <td className="px-4 py-4"><button onClick={()=>setDrillDown(c)} className="text-[#00A09D] font-black uppercase text-[11px] hover:underline">Drill Down</button></td>
                </tr>
              )} />
           </div>
           <div>
              <OdooCard title="Live Activity Drill-down" className="h-full">
                {drillDown ? (
                  <div className="space-y-6 animate-in fade-in duration-300">
                    <div className="border-b pb-4 flex justify-between items-center">
                      <h4 className="font-black text-[#714B67] uppercase text-sm tracking-tight leading-none">{drillDown.companyname}</h4>
                      <button onClick={()=>setDrillDown(null)} className="text-gray-300 hover:text-gray-600"><X size={16}/></button>
                    </div>
                    <div className="space-y-4 max-h-[500px] overflow-y-auto pr-2 scrollbar-hide">
                       {data.jobs.filter(j=>j.company === drillDown.companyname).map(j=>(
                         <div key={j.jobid} className="p-4 bg-gray-50 border-l-4 border-[#714B67] rounded-sm shadow-sm space-y-3">
                           <p className="text-xs font-black text-gray-800 uppercase tracking-tight leading-tight">{j.title}</p>
                           <div className="flex gap-2">
                              <span className="text-[8px] font-black bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-sm uppercase">{data.applications.filter(a=>a.jobid===j.jobid).length} Apps</span>
                              <span className="text-[8px] font-black bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded-sm uppercase">{data.interviews.filter(i=>i.companyname===drillDown.companyname && i.positiontitle===j.title).length} Ints</span>
                              <span className="text-[8px] font-black bg-green-100 text-green-700 px-1.5 py-0.5 rounded-sm uppercase">{data.billing.filter(b=>b.clientname === drillDown.companyname).length} Jnd</span>
                           </div>
                         </div>
                       ))}
                       {data.jobs.filter(j=>j.company === drillDown.companyname).length === 0 && (
                         <div className="text-center p-10 text-gray-300 italic text-xs">No active requirements found</div>
                       )}
                    </div>
                  </div>
                ) : (
                  <div className="h-[400px] flex flex-col items-center justify-center text-gray-300 italic text-xs text-center space-y-4">
                    <Search size={32} className="text-gray-200" />
                    <p>Select an account from the table<br/>to view job-wise candidate stages</p>
                  </div>
                )}
              </OdooCard>
           </div>
        </div>
      </div>
    );
  };

  // --- MODULE: BILLING (ADMIN) ---
  const BillingModule = () => (
    <div className="space-y-8 animate-in slide-in-from-bottom-5 duration-500">
      <h2 className="text-2xl font-black text-[#714B67] uppercase tracking-tight">Financial Overview</h2>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <OdooCard className="border-t-4 border-green-500">
          <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Gross Revenue</p>
          <p className="text-3xl font-black text-green-600">₹ {data.billing.reduce((s,b)=>s+(parseInt(b.billingamount)||0),0).toLocaleString()}</p>
        </OdooCard>
        <OdooCard className="border-t-4 border-orange-500">
          <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Outstanding</p>
          <p className="text-3xl font-black text-orange-600">₹ {data.billing.reduce((s,b)=>s+(parseInt(b.balancedue)||0),0).toLocaleString()}</p>
        </OdooCard>
        <OdooCard className="border-t-4 border-[#714B67]">
          <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Total Placements</p>
          <p className="text-3xl font-black text-[#714B67]">{data.billing.filter(b=>b.clientname).length}</p>
        </OdooCard>
      </div>
      <Table headers={["Client Account", "Candidate", "Joining Date", "Bill Amt", "Status"]} rows={data.billing.filter(b=>b.clientname)} renderRow={(b, i) => (
        <tr key={i} className="hover:bg-gray-50 transition-colors text-[11px]">
          <td className="px-4 py-4 font-black uppercase text-[#714B67]">{b.clientname}</td>
          <td className="px-4 py-4 font-bold text-gray-800">{b.candidatename}</td>
          <td className="px-4 py-4 text-gray-500 font-black">{b.joiningdate}</td>
          <td className="px-4 py-4 font-black text-green-700">₹ {parseInt(b.billingamount).toLocaleString()}</td>
          <td className="px-4 py-4"><span className={`px-2 py-1 font-black text-[9px] uppercase rounded-sm ${b.paymentstatus==='Payment Received' ? 'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>{b.paymentstatus}</span></td>
        </tr>
      )} />
    </div>
  );

  // --- TOP BAR NAVIGATION ---
  const TopBar = () => (
    <header className="h-14 bg-[#714B67] shadow-xl sticky top-0 z-[150] flex items-center justify-between px-6 text-white overflow-x-auto whitespace-nowrap scrollbar-hide">
      <div className="flex items-center gap-10 h-full">
        <div className="flex items-center gap-2 cursor-pointer transition-transform hover:scale-105" onClick={() => setView('careers')}>
          <div className="w-8 h-8 bg-white/20 rounded-sm flex items-center justify-center font-black italic shadow-inner">R</div>
          <span className="font-black tracking-tighter text-xl uppercase italic leading-none">RAVEONE</span>
        </div>
        <nav className="flex h-full items-center">
          <NavButton id="careers" label="Careers" icon={Briefcase} />
          {user && (
            <>
              <NavButton id="jobs" label="Jobs" icon={Target} />
              <NavButton id="applications" label="Apps" icon={FileText} />
              <NavButton id="sourced" label="Sourced" icon={Users} />
              <NavButton id="interviews" label="Interviews" icon={Calendar} />
              <NavButton id="clients" label="Clients" icon={Building2} />
              <NavButton id="billing" label="Billing" icon={IndianRupee} />
              <NavButton id="marketing" label="Outreach" icon={Megaphone} />
            </>
          )}
        </nav>
      </div>
      <div className="flex items-center gap-4">
        {user ? (
          <button onClick={handleLogout} className="flex items-center gap-2 text-[10px] font-black uppercase bg-white/10 px-5 py-2 rounded-sm hover:bg-white/20 transition-all shadow-md">
            <LogOut size={14}/> LOGOUT {user.name.split(' ')[0]}
          </button>
        ) : (
          <button onClick={() => setView('login')} className="text-[11px] font-black uppercase bg-[#00A09D] px-6 py-2 rounded-sm shadow-xl hover:brightness-110 transition-all tracking-widest">
            Recruiter Login
          </button>
        )}
      </div>
    </header>
  );

  return (
    <div className="min-h-screen bg-[#F0F2F5] font-sans selection:bg-[#714B67]/20 flex flex-col">
      <TopBar />
      <main className="flex-1 p-6 md:p-10 max-w-[1500px] w-full mx-auto">
        {loading ? (
          <div className="h-[70vh] flex flex-col items-center justify-center gap-6 text-gray-300">
            <Loader2 className="animate-spin text-[#714B67]" size={60} />
            <div className="text-center space-y-1">
              <p className="text-sm font-black uppercase tracking-[0.3em] text-gray-400">Database Synchronization</p>
              <p className="text-[10px] font-bold text-gray-300 italic">Connecting to Raveone Consultants Unified Cloud...</p>
            </div>
          </div>
        ) : (
          <>
            {view === 'careers' && <CareersPage />}
            {user && view === 'jobs' && <JobsModule />}
            {user && view === 'applications' && <ApplicationsModule />}
            {user && view === 'sourced' && (
              <div className="space-y-8 animate-in slide-in-from-bottom-5">
                <h2 className="text-2xl font-black text-[#714B67] uppercase tracking-tight">Outreach & Sourcing</h2>
                <Table headers={["ID", "Account", "Position", "Candidate", "Coordinates", "JD Link", "Actions"]} rows={data.sourced} renderRow={s => (
                  <tr key={s.jobid+s.sourcedemail} className="hover:bg-gray-50 transition-colors">
                    <td className="px-4 py-4 font-black text-gray-400">{s.jobid}</td>
                    <td className="px-4 py-4 font-black text-[#714B67] uppercase text-[10px] leading-tight">{s.clientid}</td>
                    <td className="px-4 py-4 font-bold text-gray-600 text-[11px] uppercase tracking-tighter">{s.positiontitle}</td>
                    <td className="px-4 py-4 font-black text-gray-800">{s.candidatesourced}</td>
                    <td className="px-4 py-4 text-gray-500 font-black text-[11px]">{s.sourcedemail}<br/><span className="text-teal-600">{s.sourcedphone}</span></td>
                    <td className="px-4 py-4"><a href={s.jdlink} target="_blank" rel="noreferrer" className="text-blue-600 flex items-center gap-1 hover:underline font-black uppercase text-[10px] tracking-tighter"><ExternalLink size={12}/> View Page</a></td>
                    <td className="px-4 py-4 flex gap-2">
                      <a href={`mailto:${s.sourcedemail}`} className="p-2 bg-purple-50 text-purple-600 rounded-sm shadow-sm hover:scale-110 transition-transform"><Mail size={16}/></a>
                      <a href={`https://wa.me/${s.sourcedphone}`} target="_blank" rel="noreferrer" className="p-2 bg-green-50 text-green-600 rounded-sm shadow-sm hover:scale-110 transition-transform"><MessageSquare size={16}/></a>
                    </td>
                  </tr>
                )} />
              </div>
            )}
            {user && view === 'interviews' && <InterviewModule />}
            {user && view === 'clients' && <ClientsModule />}
            {user && view === 'billing' && <BillingModule />}
            {user && view === 'marketing' && (
              <div className="space-y-8 animate-in slide-in-from-bottom-5">
                <h2 className="text-2xl font-black text-[#714B67] uppercase tracking-tight">Marketing Center</h2>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                   <OdooCard title="Outreach Automator">
                      <div className="space-y-6">
                        <div className="space-y-2">
                          <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Select Requirement</label>
                          <select className="w-full border-2 border-gray-100 p-3 text-sm font-bold outline-none focus:border-[#714B67] transition-all bg-white" onChange={e=>setSelectedItem(data.jobs.find(j=>j.jobid===e.target.value))}>
                            <option value="">Choose Position Role...</option>
                            {data.jobs.map(j=><option key={j.jobid} value={j.jobid}>{j.company} - {j.title}</option>)}
                          </select>
                        </div>
                        <div className="flex flex-col gap-3">
                          <button disabled={!selectedItem} onClick={async ()=>{ const ai = await generateAI(`Create professional outreach for ${selectedItem.title}`); alert(ai); }} className="w-full bg-[#714B67] text-white py-4 font-black rounded-sm shadow-xl disabled:opacity-50 uppercase tracking-[0.2em] text-xs">Generate WhatsApp Pitch</button>
                          <button disabled={!selectedItem} onClick={async ()=>{ const ai = await generateAI(`Create formal LinkedIn DM for ${selectedItem.title}`); alert(ai); }} className="w-full bg-[#00A09D] text-white py-4 font-black rounded-sm shadow-xl disabled:opacity-50 uppercase tracking-[0.2em] text-xs">Generate LinkedIn Post</button>
                        </div>
                        <div className="p-5 bg-yellow-50 border-l-4 border-yellow-400 rounded-sm">
                           <p className="text-[10px] font-bold text-yellow-800 leading-relaxed italic">Marketing content is drafted using Gemini 1.5 Flash. Please review for Raveone guidelines before broadcasting to candidates.</p>
                        </div>
                      </div>
                   </OdooCard>
                   <OdooCard title="Campaign Preview">
                      <div className="h-full flex flex-col items-center justify-center p-12 text-center text-gray-300">
                        <PieChart size={64} className="mb-4 opacity-10" />
                        <p className="text-xs font-bold uppercase tracking-widest leading-loose">Automated campaigns<br/>and broadcasting data<br/>displayed here</p>
                      </div>
                   </OdooCard>
                </div>
              </div>
            )}
          </>
        )}
      </main>
      
      {/* GLOBAL FOOTER */}
      <footer className="mt-auto h-10 border-t bg-white flex items-center justify-between px-6 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
        <span>© 2026 Raveone Consultants ATS</span>
        <div className="flex gap-4">
          <span>Unified Backend Service</span>
          <span className="text-[#00A09D] animate-pulse">● System Online</span>
        </div>
      </footer>
    </div>
  );
};

export default App;
