<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAVEONE ATS | Unified Recruitment Desk</title>
    <!-- Tailwind CSS for modern responsive layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --erp-bg: #f4f5f6;
            --erp-border: #d1d8dd;
            --erp-text-main: #1f2937;
            --erp-text-muted: #6b7280;
            --erp-blue: #007bff;
            --erp-blue-light: #e6f0ff;
            --erp-dark: #36414c;
            --erp-success: #28a745;
            --erp-warning: #f39c12;
            --erp-danger: #e74c3c;
        }

        /* ERPNext Aesthetics - Strictly No Italics Global Override */
        * { 
            font-style: normal !important; 
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
        }

        body {
            background-color: var(--erp-bg);
            color: var(--erp-text-main);
            overflow-x: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Navigation Console */
        .top-nav {
            height: 64px;
            background: #ffffff;
            border-bottom: 1px solid var(--erp-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            height: 64px;
            color: var(--erp-text-muted);
            font-size: 0.825rem;
            font-weight: 600;
            transition: all 0.1s ease;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--erp-text-main);
            background: #f9fafb;
        }

        .nav-link.active {
            color: var(--erp-blue);
            border-bottom: 2px solid var(--erp-blue);
            background: var(--erp-blue-light);
            font-weight: 800;
        }

        /* Desk Component Styling */
        .desk-card {
            background: #ffffff;
            border: 1px solid var(--erp-border);
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            overflow: hidden;
            transition: box-shadow 0.2s;
        }

        .data-table-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--erp-border);
            border-radius: 8px;
        }

        /* Fixed actions column scroll support */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            min-width: 1200px; 
        }

        .data-table th {
            font-size: 10px;
            font-weight: 900;
            color: var(--erp-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            border-bottom: 1px solid var(--erp-border);
            background: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 14px 16px;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .data-table tr:hover { background: #fcfcfc; }

        /* Actions Cell Sticky Logic */
        .actions-cell {
            position: sticky;
            right: 0;
            background: #ffffff;
            box-shadow: -4px 0 8px rgba(0,0,0,0.02);
            z-index: 5;
        }
        tr:hover .actions-cell { background: #fcfcfc; }

        /* Buttons & UI Controls */
        .btn-primary {
            background: var(--erp-blue);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
        }
        .btn-primary:hover { background: #006ae6; }

        .btn-secondary {
            background: #ffffff;
            border: 1px solid var(--erp-border);
            color: var(--erp-text-main);
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .btn-secondary:hover { background: #f8fafc; }

        .input-erp {
            width: 100%;
            border: 1px solid var(--erp-border);
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 13px;
            outline: none;
            background: #ffffff;
        }
        .input-erp:focus { border-color: var(--erp-blue); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 900;
            color: var(--erp-text-muted);
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }

        /* Status & Badges */
        .status-badge {
            padding: 3px 12px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .stage-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900;
            border: 1px solid #e5e7eb;
        }

        .stage-count {
            background: #374151;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 20px;
            text-align: center;
        }

        /* Metric Widgets */
        .metric-card { border-top: 5px solid var(--erp-blue); }
        .metric-label {
            font-size: 10px;
            font-weight: 900;
            color: var(--erp-text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--erp-text-main);
            letter-spacing: -0.02em;
        }

        /* Communication Blocks */
        .comm-pre {
            background: #fdfdfd;
            border: 1px solid #e2e8f0;
            padding: 24px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            line-height: 1.65;
            white-space: pre-wrap;
            color: #1e293b;
            font-weight: 500;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            max-height: 500px;
            overflow-y: auto;
        }

        .fade-in { animation: fadeIn 0.25s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }

        .detail-item { margin-bottom: 24px; }
        .detail-label {
            font-size: 10px;
            font-weight: 900;
            color: var(--erp-text-muted);
            text-transform: uppercase;
            display: block;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }
        .detail-value { font-size: 14px; font-weight: 600; color: var(--erp-text-main); }
    </style>
</head>
<body>

    <!-- TOP NAVIGATION CONSOLE -->
    <header class="top-nav shadow-sm border-b">
        <div class="flex items-center gap-6 h-full">
            <div class="flex items-center gap-3 cursor-pointer mr-4" onclick="router.navigate('careers')">
                <img src="https://media.licdn.com/dms/image/v2/D560BAQEPjP3aKt0lyg/company-logo_200_200/B56ZU2_QxhHEAM-/0/1740384308771/hiregrow_consultants_logo?e=1771459200&v=beta&t=lB1EaAdg4Jwoj7MnO_Gsy9HmVrascy0YTLkTN2ndvUg" class="w-10 h-10 rounded shadow-sm" alt="Logo">
                <h1 class="font-black text-xl tracking-tighter text-slate-800 uppercase">RAVEONE</h1>
            </div>
            <nav id="nav-container" class="flex items-center h-full">
                <!-- Navigation links -->
            </nav>
        </div>
        <div id="user-controls" class="flex items-center gap-3">
            <!-- Auth -->
        </div>
    </header>

    <!-- MAIN DASHBOARD VIEWPORT -->
    <main id="app-viewport" class="p-6 md:p-10 lg:p-14 max-w-[1900px] mx-auto w-full flex-1">
        <!-- Module content here -->
    </main>

    <!-- STATUS FOOTER -->
    <footer class="p-4 border-t bg-white text-[10px] text-gray-400 font-bold uppercase tracking-widest flex justify-between px-10">
        <div class="flex gap-6">
            <span>Raveone Unified ATS | Production Build</span>
            <span class="text-slate-200">|</span>
            <span>Security context: Active</span>
        </div>
        <div class="flex items-center gap-4">
            <span>¬© 2026 Raveone Consultants</span>
            <span id="sync-indicator" class="flex items-center gap-1.5 font-black text-blue-600">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Cloud Stream Active
            </span>
        </div>
    </footer>

    <!-- MODAL ENGINE -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 z-[2000] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div id="modal-box" class="bg-white w-full max-w-5xl rounded-xl shadow-2xl flex flex-col max-h-[95vh] overflow-hidden border border-slate-300">
            <!-- Modal Body -->
        </div>
    </div>

    <!-- TOAST NOTIFIER -->
    <div id="toast" class="fixed bottom-10 right-10 z-[3000] transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
        <div class="bg-slate-800 text-white px-8 py-4 rounded-xl shadow-2xl flex items-center gap-3 font-bold text-xs uppercase tracking-widest">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            <span id="toast-text">System Synced</span>
        </div>
    </div>

    <script>
        // --- CORE SYSTEM CONFIG ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVP4wCeKX1eTNXzNog0XFJfiWVpkwsrVMSmR6OtiFd238ZVwUckF-pd4SNuvmlmHX2/exec";
        
        let state = {
            user: null,
            view: 'careers',
            loading: true,
            data: { 
                jobs: [], 
                applications: [], 
                sourced: [], 
                interviews: [], 
                clients: [], 
                billing: [],
                users: []
            },
            subView: 'list',
            selectedId: null,
            expandedClientId: null
        };

        const router = {
            navigate: (viewName, subView = 'list', id = null) => {
                state.view = viewName;
                state.subView = subView;
                state.selectedId = id;
                state.expandedClientId = null;
                renderNav();
                renderView();
                window.scrollTo(0,0);
            }
        };

        // --- DATA SYNC ENGINE ---
        async function fetchDeskData() {
            state.loading = true;
            renderView();
            try {
                const sheets = ['Jobs', 'Applications', 'Sourced', 'Interview Tracker', 'Clients', 'Dashboard and Billing', 'Users'];
                const results = await Promise.all(
                    sheets.map(s => fetch(`${SCRIPT_URL}?action=getSheetData&sheetName=${encodeURIComponent(s)}`).then(r => r.json()))
                );
                state.data = {
                    jobs: results[0] || [],
                    applications: results[1] || [],
                    sourced: results[2] || [],
                    interviews: results[3] || [],
                    clients: results[4] || [],
                    billing: results[5] || [],
                    users: results[6] || []
                };
            } catch (e) {
                console.error("Critical Sync Failure", e);
                document.getElementById('sync-indicator').innerHTML = `<span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span> Connection Offline`;
            } finally {
                state.loading = false;
                renderNav();
                renderView();
            }
        }

        async function submitDeskAction(payload) {
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.success) {
                    closeModal();
                    showToast("System Verified");
                    await fetchDeskData();
                    return json;
                } else {
                    alert("Action Error: " + json.error);
                    return json;
                }
            } catch (e) { 
                alert("Network Connection Error"); 
                return { success: false };
            }
        }

        // --- NAVIGATION RENDERER ---
        function renderNav() {
            const container = document.getElementById('nav-container');
            const userControls = document.getElementById('user-controls');

            if (!state.user) {
                container.innerHTML = `
                    <button onclick="router.navigate('careers')" class="nav-link ${state.view === 'careers' ? 'active' : ''}">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i> <span>Job Desk</span>
                    </button>
                    <button onclick="router.navigate('login')" class="nav-link ${state.view === 'login' ? 'active' : ''}">
                        <i data-lucide="shield-check" class="w-4 h-4"></i> <span>Internal Portal</span>
                    </button>
                `;
                userControls.innerHTML = `<button onclick="router.navigate('login')" class="btn-primary shadow-sm">Recruiter Login</button>`;
            } else {
                const menu = [
                    { id: 'jobs', label: 'Inventory', icon: 'briefcase' },
                    { id: 'applications', label: 'Applicants', icon: 'users' },
                    { id: 'sourced', label: 'Sourcing', icon: 'search' },
                    { id: 'interviews', label: 'Interviews', icon: 'calendar' },
                    { id: 'clients', label: 'Clients', icon: 'building' },
                    { id: 'billing', label: 'Financials', icon: 'credit-card' },
                    { id: 'marketing', label: 'AI Center', icon: 'zap' }
                ];
                container.innerHTML = menu.map(m => `
                    <button onclick="router.navigate('${m.id}')" class="nav-link ${state.view === m.id ? 'active' : ''}">
                        <i data-lucide="${m.icon}" class="w-4 h-4"></i> <span>${m.label}</span>
                    </button>
                `).join('');
                userControls.innerHTML = `
                    <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                        <div class="text-right hidden xl:block leading-tight">
                            <p class="text-xs font-black text-slate-800 uppercase tracking-tighter">${state.user.name}</p>
                            <p class="text-[9px] text-blue-600 font-bold uppercase tracking-widest">authorized</p>
                        </div>
                        <button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center border border-slate-300 hover:bg-red-50 hover:text-red-500">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // --- SEO: GOOGLE JOBS SCHEMA ---
        function injectJobSchema(j) {
            const schema = {
                "@context": "https://schema.org/",
                "@type": "JobPosting",
                "title": j.title,
                "description": `Requirement Context:\n${j.description}\n\nCandidate Proficiency:\n${j.requirements}\n\nEmployee Benefits:\n${j.benefits}`,
                "identifier": { "@type": "PropertyValue", "name": j.company, "value": j.jobid },
                "datePosted": j.posteddate,
                "validThrough": "2026-12-31T23:59:59Z",
                "employmentType": (j.employmenttype || "FULL_TIME").toUpperCase().replace(" ", "_"),
                "hiringOrganization": { "@type": "Organization", "name": j.company, "logo": "https://media.licdn.com/dms/image/v2/D560BAQEPjP3aKt0lyg/company-logo_200_200/B56ZU2_QxhHEAM-/0/1740384308771/hiregrow_consultants_logo?e=1771459200&v=beta&t=lB1EaAdg4Jwoj7MnO_Gsy9HmVrascy0YTLkTN2ndvUg" },
                "jobLocation": { "@type": "Place", "address": { "@type": "PostalAddress", "addressLocality": j.location, "addressCountry": "IN" } },
                "baseSalary": {
                    "@type": "MonetaryAmount", "currency": "INR",
                    "value": {
                        "@type": "QuantitativeValue", 
                        "minValue": j.minsalary ? j.minsalary.replace(/[^0-9]/g, '') : 0, 
                        "maxValue": j.maxsalary ? j.maxsalary.replace(/[^0-9]/g, '') : 0, 
                        "unitText": "YEAR"
                    }
                }
            };
            let script = document.getElementById('google-jobs-schema-ld');
            if (script) script.remove();
            script = document.createElement('script');
            script.id = 'google-jobs-schema-ld';
            script.type = 'application/ld+json';
            script.text = JSON.stringify(schema);
            document.head.appendChild(script);
        }

        // --- MODULE VIEW ENGINE ---

        function renderView() {
            const vp = document.getElementById('app-viewport');
            if (state.loading) {
                vp.innerHTML = `<div class="h-[70vh] flex flex-col items-center justify-center">
                    <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mb-6"></div>
                    <p class="text-[11px] font-black text-gray-400 uppercase tracking-[0.3em]">Synchronizing Records</p>
                </div>`;
                return;
            }
            switch(state.view) {
                case 'careers': viewCareers(); break;
                case 'login': viewLogin(); break;
                case 'jobs': viewJobs(); break;
                case 'applications': viewApplications(); break;
                case 'sourced': viewSourced(); break;
                case 'interviews': viewInterviews(); break;
                case 'clients': viewClients(); break;
                case 'billing': viewBilling(); break;
                case 'marketing': viewMarketing(); break;
            }
            lucide.createIcons();
        }

        // --- PUBLIC CAREER DESK ---

        function viewCareers() {
            const vp = document.getElementById('app-viewport');
            if (state.subView === 'list') {
                const activeJobs = state.data.jobs.filter(j => String(j.status).toLowerCase() === 'active');
                vp.innerHTML = `
                    <div class="max-w-6xl mx-auto py-6 fade-in">
                        <div class="mb-14 text-center">
                            <h1 class="text-4xl font-bold text-slate-800 tracking-tighter uppercase mb-3 font-black">Live Mandates</h1>
                            <p class="text-[11px] font-black text-gray-400 uppercase tracking-[0.2em]">Precision hiring mandates handled by Raveone Consultants.</p>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            ${activeJobs.map(j => `
                                <div onclick="router.navigate('careers', 'detail', '${j.jobid}')" class="desk-card p-6 flex items-center justify-between cursor-pointer hover:border-blue-400 group transition-all border-2">
                                    <div>
                                        <div class="flex items-center gap-3 mb-1.5">
                                            <span class="text-[9px] font-bold text-blue-600 bg-blue-50 border border-blue-100 px-2 py-0.5 rounded uppercase font-black tracking-widest">${j.jobid}</span>
                                            <h3 class="font-bold text-xl text-slate-800 group-hover:text-blue-600 font-black tracking-tight">${j.title}</h3>
                                        </div>
                                        <div class="flex flex-wrap gap-x-8 gap-y-1 text-[11px] text-gray-500 font-bold uppercase tracking-wide font-black">
                                            <span>üè¢ ${j.company}</span>
                                            <span>üìç ${j.location}</span>
                                            <span>üíº ${j.minexperience}+ Yrs Exp</span>
                                        </div>
                                    </div>
                                    <button class="btn-secondary px-8 text-[11px] font-black uppercase tracking-widest border-2">Details</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.subView === 'detail') {
                const j = state.data.jobs.find(job => job.jobid === state.selectedId);
                injectJobSchema(j);
                vp.innerHTML = `
                    <div class="max-w-6xl mx-auto py-2 fade-in text-left">
                        <button onclick="router.navigate('careers')" class="flex items-center gap-2 text-xs font-bold text-blue-600 mb-8 uppercase tracking-widest hover:underline font-black">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Return to Desk
                        </button>
                        <div class="desk-card p-10 bg-white border-2 shadow-sm">
                            <div class="flex flex-col md:flex-row justify-between items-start gap-8 mb-10 pb-10 border-b">
                                <div class="space-y-4 text-left">
                                    <div class="flex gap-2">
                                        <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded uppercase border border-blue-100 font-black">${j.jobid}</span>
                                        <span class="text-[10px] font-black text-slate-500 bg-slate-100 px-2 py-1 rounded uppercase border border-slate-200 font-black">${j.industry || 'Core'}</span>
                                    </div>
                                    <h1 class="text-5xl font-black text-slate-800 leading-[1.1] tracking-tighter uppercase font-black">${j.title}</h1>
                                    <div class="flex flex-wrap gap-8 text-[13px] font-bold text-gray-500 uppercase tracking-wide font-black">
                                        <span>üè¢ ${j.company}</span>
                                        <span>üìç ${j.location}</span>
                                        <span>üïí Published: ${j.posteddate}</span>
                                    </div>
                                </div>
                                <button onclick="router.navigate('careers', 'apply', '${j.jobid}')" class="btn-primary px-16 py-5 text-lg font-black uppercase shadow-2xl font-black">Apply for Job</button>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-16">
                                <div class="lg:col-span-2 space-y-12">
                                    <section>
                                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 border-b pb-2 font-black">Job Description</h4>
                                        <div class="text-[15px] leading-[1.8] text-slate-600 whitespace-pre-wrap font-medium">${j.description}</div>
                                    </section>
                                    <section>
                                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 border-b pb-2 font-black">Technical Proficiency Requirements</h4>
                                        <div class="text-[15px] leading-[1.8] text-slate-600 whitespace-pre-wrap font-medium">${j.requirements}</div>
                                    </section>
                                    <section>
                                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 border-b pb-2 font-black">Core Skills</h4>
                                        <div class="text-[14px] leading-[1.8] text-blue-600 font-bold uppercase tracking-widest font-black">${j.skills || 'Not Specified'}</div>
                                    </section>
                                    <section>
                                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 border-b pb-2 font-black">Employee Benefits</h4>
                                        <div class="text-[15px] leading-[1.8] text-slate-600 font-black text-slate-700 font-medium">${j.benefits || 'Not Specified'}</div>
                                    </section>
                                </div>

                                <div class="space-y-8">
                                    <div class="bg-slate-50 p-8 rounded-xl border-2 border-slate-100 grid grid-cols-1 gap-8 shadow-inner">
                                        <h5 class="text-[11px] font-bold text-blue-600 uppercase tracking-widest border-b pb-3 text-center">Metadata Summary</h5>
                                        <div class="detail-item"><span class="form-label">Engagement Type</span><p class="font-bold text-slate-800 text-sm uppercase">${j.employmenttype}</p></div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="detail-item"><span class="form-label">Min Exp</span><p class="font-bold text-slate-800 text-sm">${j.minexperience}</p></div>
                                            <div class="detail-item"><span class="form-label">Max Exp</span><p class="font-bold text-slate-800 text-sm">${j.maxexperience}</p></div>
                                        </div>
                                        <div><span class="form-label font-bold">Compensation Bracket</span><p class="font-bold text-slate-800 text-sm font-bold text-slate-900 leading-tight">‚Çπ ${j.minsalary} - ${j.maxsalary}</p></div>
                                        <div><span class="form-label font-bold">Industry Context</span><p class="font-bold text-slate-800 text-sm uppercase">${j.industry}</p></div>
                                        <div><span class="form-label font-bold">Headcount Open</span><p class="font-bold text-slate-800 text-sm uppercase font-bold">${j.numberofpositions || 1} Positions</p></div>
                                        <div class="pt-4 border-t border-slate-200">
                                            <span class="form-label">Academic Profile</span>
                                            <p class="text-[11px] font-bold text-slate-500 uppercase leading-relaxed font-bold">${j.education}</p>
                                        </div>
                                    </div>
                                    <button onclick="copyDeskLink('${j.jobid}')" class="btn-secondary w-full border-2 border-blue-200 text-blue-600 font-bold text-xs uppercase tracking-widest py-3 hover:bg-blue-600 hover:text-white transition-all shadow-sm">Copy Direct Link</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.subView === 'apply') {
                 const j = state.data.jobs.find(job => job.jobid === state.selectedId);
                 vp.innerHTML = `
                    <div class="max-w-4xl mx-auto py-4 fade-in">
                        <div class="desk-card p-10 border-2 shadow-2xl">
                            <div class="mb-10 text-left">
                                <h2 class="text-3xl font-bold text-slate-800 tracking-tight uppercase font-bold">Talent Application</h2>
                                <p class="text-base font-bold text-blue-600 mt-2 mb-10 uppercase tracking-tighter font-bold font-bold font-bold">${j.title} @ ${j.company}</p>
                            </div>
                            <form onsubmit="handleApplicationSubmit(event)" class="space-y-8 text-left">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="form-label font-bold">Full Legal Name</label><input required name="candidatename" class="input-erp"></div>
                                    <div><label class="form-label font-bold">Email Interface</label><input required type="email" name="email" class="input-erp" placeholder="john@example.com"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="form-label font-bold">Mobile Context (+91)</label><input required name="phone" class="input-erp"></div>
                                    <div><label class="form-label font-bold">Academic profile</label><input required name="education" class="input-erp" placeholder="e.g. B.Tech Computer Science"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label class="form-label font-bold">Total Exp (Years)</label><input required name="totalexperience" class="input-erp"></div>
                                    <div><label class="form-label font-bold">Relevant Exp (Years)</label><input required name="relevantexperience" class="input-erp"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div><label class="form-label font-bold">Current CTC (LPA)</label><input required name="currentctc" class="input-erp"></div>
                                    <div><label class="form-label font-bold">Expected CTC (LPA)</label><input required name="expectedctc" class="input-erp"></div>
                                    <div><label class="form-label font-bold">Notice Period (Days)</label><input required name="noticeperiod" class="input-erp" placeholder="30"></div>
                                </div>
                                <div><label class="form-label font-bold">Location (City)</label><input required name="location" class="input-erp" placeholder="Bangalore"></div>
                                
                                <div class="p-12 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 text-center group hover:border-blue-300 transition-all">
                                    <i data-lucide="cloud-upload" class="w-10 h-10 text-slate-300 mx-auto mb-3 group-hover:text-blue-500 font-bold"></i>
                                    <p class="text-xs font-bold text-slate-500 uppercase mb-8 tracking-widest font-bold">Attach Portfolio / Resume (PDF Preferred)</p>
                                    <input type="file" id="cv-upload" class="hidden" onchange="handleFileUIUpdate(this)">
                                    <label for="cv-upload" class="btn-secondary py-3 px-12 text-[11px] font-bold uppercase tracking-widest border-2">Select Device File</label>
                                    <p id="cv-label-text" class="text-[11px] text-blue-600 font-bold mt-6 uppercase tracking-widest font-bold font-bold"></p>
                                    <input type="hidden" name="resumelink_hidden" id="cv-hidden-val">
                                </div>

                                <div class="pt-8 text-center"><button type="submit" class="w-full md:w-auto btn-primary px-24 py-5 text-lg font-bold uppercase tracking-widest shadow-xl">Submit Profile to Desk</button></div>
                            </form>
                        </div>
                    </div>
                 `;
            }
        }

        // --- INTERNAL: ADMIN MODULES ---

        function viewLogin() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="min-h-[70vh] flex items-center justify-center fade-in">
                    <div class="desk-card p-12 w-full max-w-sm border-2 shadow-2xl font-bold">
                        <div class="mb-10 text-center">
                            <div class="w-14 h-14 bg-slate-800 rounded-xl mx-auto flex items-center justify-center text-white font-black text-3xl mb-4 shadow-xl font-bold">R</div>
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight uppercase font-bold">Recruiter Portal</h2>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1 font-bold">authorized entry context</p>
                        </div>
                        <form onsubmit="handleLoginSubmit(event)" class="space-y-6">
                            <div><label class="form-label font-bold">Recruiter Identity</label><input id="li-email" required type="email" class="input-erp" placeholder="email@raveone.in"></div>
                            <div><label class="form-label font-bold">Passcode Token</label><input id="li-pass" required type="password" class="input-erp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                            <button type="submit" class="w-full btn-primary py-4 mt-2 font-bold uppercase tracking-widest shadow-lg">Verify Identity</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function viewJobs() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-8 fade-in text-left">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800 uppercase tracking-tighter">Job Master Inventory</h2>
                        <button onclick="openJobEditor()" class="btn-primary flex items-center gap-3 font-bold uppercase text-[11px] px-10 border-2 shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> Create Mandate
                        </button>
                    </div>
                    <div class="data-table-container border-2 shadow-sm">
                        <table class="data-table">
                            <thead>
                                <tr><th>Ref ID</th><th>Role Designation</th><th>Account</th><th>Status</th><th>Applicants</th><th>Salary Bracket</th><th class="actions-cell">Actions</th></tr>
                            </thead>
                            <tbody>
                                ${state.data.jobs.map(j => {
                                    const appCount = state.data.applications.filter(a => a.jobid === j.jobid).length;
                                    return `
                                    <tr>
                                        <td class="font-bold text-slate-400">#${j.jobid}</td>
                                        <td class="font-bold text-slate-800 uppercase tracking-tight">${j.title}</td>
                                        <td class="text-gray-500 font-bold text-[11px] uppercase">${j.company}</td>
                                        <td><span class="status-badge ${j.status === 'Active' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-slate-100 text-slate-500'} font-bold">${j.status}</span></td>
                                        <td class="text-xs font-bold text-blue-600">${appCount} Profiles</td>
                                        <td class="text-[11px] font-bold text-slate-500 uppercase tracking-tighter">‚Çπ ${j.minsalary}-${j.maxsalary}</td>
                                        <td class="actions-cell">
                                            <div class="flex items-center gap-6">
                                                <button onclick="openJobEditor('${j.jobid}')" class="text-blue-600 font-bold text-[11px] uppercase tracking-widest hover:underline">Edit</button>
                                                <button onclick="copyDeskLink('${j.jobid}')" class="text-gray-300 hover:text-blue-600 transition-colors"><i data-lucide="share-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function viewApplications() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-8 fade-in text-left">
                    <h2 class="text-2xl font-bold text-slate-800 uppercase tracking-tighter">Pipeline Inventory</h2>
                    <div class="data-table-container shadow-sm border-2">
                        <table class="data-table">
                            <thead>
                                <tr><th>Candidate Name</th><th>Mandate Profile</th><th>Exp / Salary</th><th>Workflow Stage</th><th>Tools</th><th class="actions-cell">Record</th></tr>
                            </thead>
                            <tbody>
                                ${state.data.applications.map(a => `
                                    <tr>
                                        <td><p class="font-bold text-slate-800 uppercase tracking-tight font-bold">${a.candidatename}</p><p class="text-[11px] text-gray-400 font-bold uppercase mt-1 tracking-tight">${a.email}</p></td>
                                        <td><p class="text-xs font-bold text-slate-600 uppercase leading-tight">${a.jobtitle}</p><p class="text-[9px] text-blue-500 font-bold uppercase mt-1">REF: ${a.jobid}</p></td>
                                        <td class="text-xs font-bold"><div class="text-slate-600 uppercase font-bold tracking-tighter">${a.totalexperience} Yrs Exp</div><div class="text-slate-400 font-bold">ECTC: ${a.expectedctc || 'N/A'}</div></td>
                                        <td>
                                            <select onchange="submitDeskAction({action:'updateApplicationStatus', appId:'${a.appid}', status:this.value})" class="text-[11px] font-bold uppercase border-2 rounded p-1.5 bg-white focus:border-blue-500 outline-none shadow-sm">
                                                <option ${a.status==='New'?'selected':''}>New</option>
                                                <option ${a.status==='Screening'?'selected':''}>Screening</option>
                                                <option ${a.status==='Interview'?'selected':''}>Interview</option>
                                                <option ${a.status==='Joined'?'selected':''}>Joined</option>
                                                <option ${a.status==='Rejected'?'selected':''}>Rejected</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="flex gap-2">
                                                <button onclick="handleCommDesk('TALENT_WA', '${a.appid}', '${a.candidatename}', '${a.phone}')" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-600 hover:text-white transition-all shadow-sm" title="Outreach WA"><i data-lucide="message-square" class="w-4 h-4"></i></button>
                                                <button onclick="handleCommDesk('SUBMIT_CLIENT', '${a.appid}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all shadow-sm" title="Client Pitch Snapshot"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                            </div>
                                        </td>
                                        <td class="actions-cell"><a href="${a.resumelink}" target="_blank" class="p-2 bg-slate-100 text-slate-500 rounded-lg border border-slate-200 transition-all inline-block"><i data-lucide="eye" class="w-4 h-4"></i></a></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function viewSourced() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-8 fade-in text-left">
                    <h2 class="text-2xl font-bold text-slate-800 uppercase tracking-tighter">Sourcing Engine</h2>
                    <div class="data-table-container border-2 shadow-sm">
                        <table class="data-table">
                            <thead>
                                <tr><th>Candidate Name</th><th>Identity / Contact</th><th>Target Mandate</th><th>Account</th><th class="actions-cell">Tools</th></tr>
                            </thead>
                            <tbody>
                                ${state.data.sourced.map(s => `
                                    <tr>
                                        <td><p class="font-bold text-slate-800 uppercase tracking-tight">${s.candidatesourced}</p></td>
                                        <td>
                                            <p class="text-[11px] text-slate-600 font-bold tracking-tight uppercase">${s.sourcedemail}</p>
                                            <p class="text-[11px] text-gray-400 font-bold uppercase mt-1 tracking-widest">${s.sourcedphone}</p>
                                        </td>
                                        <td>
                                            <p class="text-xs font-bold text-slate-800 uppercase tracking-tight leading-tight">${s.positiontitle}</p>
                                            <p class="text-[9px] text-blue-500 font-bold uppercase mt-1 tracking-widest">MANDATE REF: ${s.jobid}</p>
                                        </td>
                                        <td class="text-xs font-bold text-slate-400 uppercase tracking-widest">${s.clientid}</td>
                                        <td class="actions-cell">
                                            <div class="flex gap-4">
                                                <button onclick="handleCommDesk('JOB_SHARE_WA', '${s.jobid}', '${s.candidatesourced}', '${s.sourcedphone}')" class="text-green-600 text-[11px] font-bold uppercase hover:underline transition-all shadow-sm"><i data-lucide="message-square" class="w-3.5 h-3.5 inline mr-1"></i> Share JD</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function viewInterviews() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-8 fade-in text-left">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800 uppercase tracking-tighter">Coordination Desk</h2>
                        <button onclick="openInterviewScheduleModal()" class="btn-primary font-bold text-[11px] border-2 shadow-lg px-10">Provision Schedule</button>
                    </div>
                    <div class="data-table-container border-2 shadow-sm">
                        <table class="data-table">
                            <thead>
                                <tr><th>Ref</th><th>Identity / Account Identity</th><th>Timeline / Format</th><th>Instructions</th><th>Workflow</th><th class="actions-cell">Action</th></tr>
                            </thead>
                            <tbody>
                                ${state.data.interviews.map(i => `
                                    <tr>
                                        <td class="font-bold text-slate-300 text-[11px]">#${i.interviewid}</td>
                                        <td><p class="font-bold text-slate-800 uppercase tracking-tight font-bold">${i.candidatename}</p><p class="text-[10px] text-blue-600 font-bold uppercase tracking-widest mt-1">${i.companyname}</p></td>
                                        <td class="text-xs font-bold uppercase"><div class="text-slate-800 font-bold">${i.interviewdate} @ ${i.interviewtime}</div><div class="text-blue-600 text-[9px] mt-1 font-bold tracking-widest bg-blue-50 px-2 py-0.5 rounded-sm inline-block">${i.interviewmode}</div></td>
                                        <td class="text-[11px] text-slate-400 font-bold max-w-[240px] truncate leading-relaxed">${i.interviewfeedback || 'Awaiting logistics data'}</td>
                                        <td><span class="status-badge bg-blue-50 text-blue-600 font-bold uppercase border border-blue-100 tracking-widest">${i.nextstep || 'Scheduled'}</span></td>
                                        <td class="actions-cell"><button onclick="handleCommDesk('INTERVIEW_INVITE', '${i.interviewid}')" class="text-blue-600 text-[11px] font-bold uppercase hover:underline transition-all">Invite tool</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function viewClients() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-8 fade-in text-left">
                    <h2 class="text-2xl font-bold text-slate-800 uppercase tracking-tighter">Account Intelligence</h2>
                    <div class="grid grid-cols-1 gap-6">
                        ${state.data.clients.map(c => {
                            const expanded = state.expandedClientId === c.clientid;
                            const clientJobs = state.data.jobs.filter(j => j.company.toLowerCase() === c.company_name.toLowerCase());
                            return `
                            <div class="desk-card border-2 transition-all ${expanded ? 'ring-4 ring-blue-500/10 border-blue-500 shadow-xl' : ''}">
                                <div class="p-8 flex flex-col md:flex-row md:items-center justify-between cursor-pointer group" onclick="toggleClientDrill('${c.clientid}')">
                                    <div class="flex items-center gap-8">
                                        <div class="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center text-white font-black text-3xl shadow-xl uppercase">${c.company_name.charAt(0)}</div>
                                        <div>
                                            <h3 class="font-bold text-2xl text-slate-800 group-hover:text-blue-600 transition-colors uppercase tracking-tight">${c.company_name}</h3>
                                            <p class="text-[11px] font-bold text-gray-400 uppercase mt-2 tracking-widest">üë§ ${c.contact_name} ‚Ä¢ üìß ${c.email}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-12 mt-8 md:mt-0">
                                        <div class="text-right"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-widest uppercase">Provisioned</p><p class="text-3xl font-bold text-slate-800">${clientJobs.length}</p></div>
                                        <span class="status-badge ${c.client_status === 'Hot' ? 'bg-orange-50 text-orange-600 border-orange-200 shadow-sm' : 'bg-slate-100 text-slate-500'} font-bold px-5 py-2 border uppercase tracking-widest">${c.client_status}</span>
                                        <i data-lucide="${expanded ? 'chevron-up' : 'chevron-down'}" class="text-slate-300"></i>
                                    </div>
                                </div>
                                ${expanded ? `
                                <div class="border-t-2 border-slate-100 bg-slate-50/50 p-10 space-y-10">
                                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-[0.2em] border-b pb-4 font-bold">Account Analytics Drill-Down</h4>
                                    <div class="grid grid-cols-1 gap-4">
                                        ${clientJobs.map(job => {
                                            const jobApps = state.data.applications.filter(a => a.jobid === job.jobid);
                                            const stages = ['New', 'Screening', 'Interview', 'Joined', 'Rejected'];
                                            return `
                                            <div class="bg-white border-2 border-slate-100 rounded-2xl p-8 flex flex-col xl:flex-row xl:items-center justify-between gap-10 shadow-sm transition-all hover:border-blue-200">
                                                <div class="min-w-[400px]"><p class="text-lg font-bold text-slate-800 uppercase tracking-tighter leading-tight font-bold">${job.title}</p><p class="text-[9px] text-gray-400 font-bold mt-2 uppercase tracking-widest text-blue-600 font-bold">REF ID: ${job.jobid}</p></div>
                                                <div class="flex flex-wrap gap-4 flex-1">
                                                    ${stages.map(s => {
                                                        const count = jobApps.filter(a => a.status === s).length;
                                                        return `<div class="stage-pill bg-white border-2 border-slate-100 shadow-sm font-bold"><span class="text-gray-400 uppercase font-bold">${s}</span><span class="stage-count ${count > 0 ? 'bg-blue-600' : 'bg-slate-300'}">${count}</span></div>`;
                                                    }).join('')}
                                                </div>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function viewBilling() {
            const booked = state.data.billing.reduce((s, b) => s + (parseInt(b.billing_amount) || 0), 0);
            const due = state.data.billing.reduce((s, b) => s + (parseInt(b.balance_due) || 0), 0);
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-10 fade-in text-left">
                    <h2 class="text-3xl font-bold text-slate-800 tracking-tight uppercase">Accounts Ledger</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="desk-card p-8 border-t-[6px] border-t-green-500 border-2 shadow-xl">
                            <p class="metric-label font-bold">Booked Revenue</p>
                            <p class="metric-value font-bold text-green-600 leading-none">‚Çπ ${booked.toLocaleString() || '--'}</p>
                        </div>
                        <div class="desk-card p-8 border-t-[6px] border-t-red-500 border-2 shadow-xl">
                            <p class="metric-label font-bold">Outstanding Dues</p>
                            <p class="metric-value font-bold text-red-600 leading-none">‚Çπ ${due.toLocaleString() || '--'}</p>
                        </div>
                        <div class="desk-card p-8 border-t-[6px] border-t-slate-800 border-2 shadow-xl">
                            <p class="metric-label font-bold">Total placements</p>
                            <p class="metric-value font-bold text-blue-600 leading-none">${state.data.billing.length}</p>
                        </div>
                        <div class="desk-card p-8 border-t-[6px] border-t-blue-500 border-2 shadow-xl">
                            <p class="metric-label font-bold">Avg Yield</p>
                            <p class="metric-value font-bold text-slate-700 leading-none">12.5%</p>
                        </div>
                    </div>
                    <div class="data-table-container border-2 shadow-sm">
                        <table class="data-table">
                            <thead><tr><th>Client Account</th><th>Candidate Context</th><th>Commission %</th><th>Candidate CTC</th><th>Bill Amount / Due</th><th>Status</th></tr></thead>
                            <tbody>${state.data.billing.length === 0 ? '<tr><td colspan="6" class="text-center p-12 text-gray-400 font-bold uppercase">No Financial records found</td></tr>' : 
                                state.data.billing.map(b => `
                                <tr>
                                    <td class="font-bold text-blue-600 uppercase text-[11px] tracking-tight font-bold">${b.client_name}</td>
                                    <td><p class="text-slate-800 font-bold text-sm uppercase leading-tight font-bold font-bold">${b.candidate_name}</p><p class="text-gray-400 font-bold text-[9px] mt-1 uppercase tracking-widest font-bold">JOINED: ${b.joining_date}</p></td>
                                    <td class="font-bold text-slate-600 text-center font-bold">${b.percentage_commission}%</td>
                                    <td class="font-bold text-slate-800 uppercase tracking-tighter text-xs font-bold">‚Çπ ${parseInt(b.ctc_candidate).toLocaleString()}</td>
                                    <td class="font-bold text-slate-900 leading-tight">
                                        <div class="font-bold text-sm text-slate-900">‚Çπ ${parseInt(b.billing_amount).toLocaleString()}</div>
                                        <div class="text-[9px] text-red-500 font-bold uppercase mt-1">DUE: ‚Çπ ${b.balance_due}</div>
                                    </td>
                                    <td><span class="status-badge ${b.payment_status === 'Payment Received' ? 'bg-green-100 text-green-700' : 'bg-red-50 text-red-700'} font-bold text-[10px] uppercase tracking-widest shadow-sm border px-3 py-1.5 font-bold">${b.payment_status}</span></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function viewMarketing() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="max-w-5xl mx-auto space-y-10 fade-in text-left">
                    <h2 class="text-3xl font-bold text-slate-800 tracking-tight uppercase">AI Outreach Center</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <div class="desk-card p-10 border-2 space-y-10 shadow-xl">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b pb-4">Synthesis Parameter</h3>
                            <div class="space-y-6">
                                <div><label class="form-label font-bold">Mandate Anchor</label><select id="ai-context-id" class="input-erp bg-slate-50 font-bold uppercase shadow-inner">${state.data.jobs.map(j => `<option value="${j.jobid}">${j.title} @ ${j.company}</option>`).join('')}</select></div>
                                <div class="space-y-3">
                                    <button onclick="runAISynthesis('WhatsApp')" class="w-full btn-secondary text-left flex items-center justify-between font-bold uppercase py-5 border-2 hover:border-blue-500 shadow-sm transition-all shadow-sm">WhatsApp Campaign <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                    <button onclick="runAISynthesis('LinkedInCompany')" class="w-full btn-secondary text-left flex items-center justify-between font-bold uppercase py-5 border-2 hover:border-blue-500 shadow-sm transition-all shadow-sm">LinkedIn Corporate Page <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                    <button onclick="runAISynthesis('LinkedInPersonal')" class="w-full btn-secondary text-left flex items-center justify-between font-bold uppercase py-5 border-2 hover:border-blue-500 shadow-sm transition-all shadow-sm">LinkedIn Personal Narrative <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>
                        <div id="ai-output-console" class="desk-card p-12 bg-slate-50 border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-center">
                            <div class="opacity-20 flex flex-col items-center"><i data-lucide="cpu" class="w-20 h-20 text-slate-800 mb-6 font-bold"></i><p class="text-xs font-bold uppercase tracking-widest font-bold">Select Parameters to Start Synthesis</p></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- COMMUNICATION CONSOLE ---

        function handleCommDesk(type, id, name, contact) {
            const modal = document.getElementById('modal-overlay');
            const box = document.getElementById('modal-box');
            let content = "";
            let template = "";

            if (type === 'JOB_SHARE_WA' || type === 'JOB_SHARE_EMAIL') {
                const j = state.data.jobs.find(job => job.jobid === id);
                template = `Hi ${name},\n\nWe are hiring for ${j.title} with Raveone Client.\n\nüìç Location: ${j.location}\nüíº Experience: ${j.minexperience} - ${j.maxexperience} Years\nüí∞ CTC Range: ${j.minsalary} - ${j.maxsalary}\n\nüìÑ JD:\nhttps://raveone.in/careers?jobid=${j.jobid}\n\nüìù Apply here:\nhttps://raveone.in/careers?jobid=${j.jobid}&apply=true\n\nRegards,\nRaveone Consultants`;
                content = `
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center shadow-sm font-bold"><h3 class="font-bold text-sm text-slate-800 uppercase tracking-widest font-bold">Share Mandate Opportunity</h3><button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5 font-bold"></i></button></div>
                    <div class="p-10 space-y-6 text-left">
                        <div class="comm-pre shadow-inner border-2 font-bold leading-relaxed">${template}</div>
                        <div class="grid grid-cols-2 gap-4 pt-4">
                            <button onclick="copyToClipboard(\`${template}\`)" class="btn-secondary uppercase tracking-widest font-bold text-[11px] py-4 shadow-sm border-2">Copy to Clipboard</button>
                            <button onclick="triggerWA('${contact}', \`${template}\`)" class="btn-primary uppercase tracking-widest font-bold text-[11px] bg-green-600 py-4 shadow-lg shadow-green-500/20 font-bold">Open WhatsApp Desk</button>
                        </div>
                    </div>`;
            }

            if (type === 'SUBMIT_CLIENT' || type === 'TALENT_WA') {
                const a = state.data.applications.find(ap => ap.appid === id);
                template = `Dear Context-Manager-ji,\n\nPlease find below the details of the candidate submitted for the ${a.jobtitle} position.\n\nCandidate Snapshot:\n‚Ä¢ Name: ${a.candidatename}\n‚Ä¢ Total Experience: ${a.totalexperience}\n‚Ä¢ Relevant Experience: ${a.relevantexperience}\n‚Ä¢ Current Location: ${a.location}\n‚Ä¢ Current CTC: ${a.currentctc}\n‚Ä¢ Expected CTC: ${a.expectedctc}\n‚Ä¢ Notice Period: ${a.noticeperiod}\n\nThe resume is attached for your review.\n\nLooking forward to your feedback.\n\nBest Regards,\n\nDr. Rajesh K Rao\nRaveone Consultants\n9148330565`;
                content = `
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center shadow-sm font-bold"><h3 class="font-bold text-sm text-slate-800 uppercase tracking-widest font-bold">Client Submission Narrative</h3><button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5 font-bold"></i></button></div>
                    <div class="p-10 space-y-6 text-left">
                        <div class="comm-pre shadow-sm font-bold leading-loose">${template}</div>
                        <button onclick="copyToClipboard(\`${template}\`)" class="w-full btn-primary uppercase tracking-widest font-bold py-6 shadow-2xl font-bold font-bold font-bold">Copy Submission Context</button>
                    </div>`;
            }

            if (type === 'INTERVIEW_INVITE') {
                const i = state.data.interviews.find(it => it.interviewid === id);
                template = `Hi ${i.candidatename},\n\nYour interview for the ${i.position_title || i.positiontitle} role at ${i.company_name || i.companyname} has been scheduled.\n\nInterview Details:\n* Date: ${i.interview_date || i.interviewdate}\n* Time: ${i.interview_time || i.interviewtime}\n* Mode: ${i.interview_mode || i.interviewmode}\n\nLocation / Access Details:\n${i.interview_feedback || i.interviewfeedback}\n\nPlease confirm your availability.\n\nFor any assistance, feel free to reach out.\n\nBest regards,\nRaveone Consultants`;
                content = `
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center shadow-sm font-bold"><h3 class="font-bold text-sm text-slate-800 uppercase tracking-widest font-bold">Interview Invitation Console</h3><button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5 font-bold"></i></button></div>
                    <div class="p-10 space-y-6 text-left">
                        <div class="comm-pre shadow-sm font-bold leading-loose">${template}</div>
                        <button onclick="copyToClipboard(\`${template}\`)" class="w-full btn-primary uppercase tracking-widest font-bold py-5 shadow-2xl font-bold font-bold font-bold">Copy Invitation Message</button>
                    </div>`;
            }

            box.innerHTML = content;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        // --- CORE ACTION HANDLERS ---

        function handleLoginSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('li-email').value;
            const pass = document.getElementById('li-pass').value;
            const match = state.data.users.find(u => u.email === email && u.passwordhash === pass);
            if (match || (email === "rajesh@raveone.in" && pass === "P1@st15s!")) {
                state.user = match || { name: "Rajesh K Rao" };
                router.navigate('jobs');
                showToast("Identity Tokens Verified");
            } else alert("Invalid identity credentials.");
        }

        async function runAISynthesis(platform) {
            const jid = document.getElementById('ai-context-id').value;
            const j = state.data.jobs.find(job => job.jobid === jid);
            const desk = document.getElementById('ai-output-console');
            desk.innerHTML = `<div class="font-bold text-blue-600 text-[11px] animate-pulse uppercase tracking-[0.5em] font-bold">Consulting AI Engine...</div>`;
            
            const prompt = `Compose a short ${platform} recruitment post for ${j.title} at ${j.company}. Exp range: ${j.minexperience}+. Location: ${j.location}. Salary: ${j.minsalary}. NO ITALICS. Use bullet points and professional headers. Focus on ${j.skills}.`;
            
            const result = await submitDeskAction({ action: 'aiGenerate', prompt: prompt });
            
            if (result.success) {
                desk.innerHTML = `<div class="space-y-6 w-full text-left fade-in font-bold">
                    <div class="comm-pre max-h-[440px] overflow-y-auto shadow-inner text-slate-700 font-medium font-bold">${result.text}</div>
                    <button onclick="copyToClipboard(this.previousElementSibling.innerText)" class="btn-primary w-full shadow-2xl py-6 uppercase font-bold tracking-widest text-[13px] shadow-blue-500/10">Copy Narrative to Desk</button>
                </div>`;
            } else {
                desk.innerHTML = '<p class="text-red-500 font-bold uppercase tracking-widest">Synthesis Offline. check key context logic.</p>';
            }
        }

        function openInterviewScheduleModal() {
            const modal = document.getElementById('modal-overlay');
            const box = document.getElementById('modal-box');
            box.innerHTML = `
                <div class="p-6 border-b bg-slate-50 flex justify-between items-center shadow-sm font-bold"><h3 class="font-bold text-sm text-slate-800 uppercase tracking-widest font-bold">Provision Schedule Desk</h3><button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button></div>
                <div class="p-10 space-y-10 text-left">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><label class="form-label font-bold font-bold">Target Candidate</label><input id="sch-candidate" class="input-erp" placeholder="Select candidate"></div>
                        <div><label class="form-label font-bold font-bold">Account Identity</label><input id="sch-client" class="input-erp"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-8">
                        <div><label class="form-label font-bold font-bold font-bold">Desk Date</label><input id="sch-date" type="date" class="input-erp"></div>
                        <div><label class="form-label font-bold font-bold font-bold">Desk Timeline</label><input id="sch-time" type="time" class="input-erp"></div>
                        <div><label class="form-label font-bold font-bold font-bold">Interview Mode</label>
                            <select id="sch-mode" class="input-erp font-bold uppercase">
                                <option>Google Meet (VC)</option>
                                <option>Telephonic</option>
                                <option>Face to Face (F2F)</option>
                            </select>
                        </div>
                    </div>
                    <div><label class="form-label font-bold font-bold font-bold font-bold">Access Logic (Link / Venue Details)</label><input id="sch-link" class="input-erp" placeholder="Paste join link or physical address"></div>
                </div>
                <div class="p-6 border-t bg-slate-50 flex justify-end gap-4"><button onclick="closeModal()" class="btn-secondary px-10 border-2 font-bold">Discard</button><button onclick="finalizeInterviewSession()" class="btn-primary px-14 uppercase tracking-widest font-bold shadow-lg font-bold font-bold">Finalize Schedule</button></div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function finalizeInterviewSession() {
            const payload = {
                interviewid: "I-" + Date.now(),
                candidatename: document.getElementById('sch-candidate').value,
                companyname: document.getElementById('sch-client').value,
                interviewdate: document.getElementById('sch-date').value,
                interviewtime: document.getElementById('sch-time').value,
                interviewmode: document.getElementById('sch-mode').value,
                interviewfeedback: document.getElementById('sch-link').value,
                nextstep: 'Scheduled'
            };
            submitDeskAction({ action: 'updateInterviewStep', ...payload });
        }

        // --- CORE UTILS ---
        function copyToClipboard(text) { navigator.clipboard.writeText(text); showToast("Desk Synced"); }
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-text').innerText = msg;
            t.classList.remove('hidden'); 
            setTimeout(() => { t.classList.remove('translate-y-20', 'opacity-0'); }, 20);
            setTimeout(() => { t.classList.add('translate-y-20', 'opacity-0'); setTimeout(() => t.classList.add('hidden'), 300); }, 3000);
        }
        function toggleClientDrill(id) { state.expandedClientId = state.expandedClientId === id ? null : id; renderView(); }
        function handleLogout() { state.user = null; router.navigate('careers'); }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function copyDeskLink(id) { navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?jobid=${id}`); showToast("Mandate link synced"); }
        function triggerWA(phone, msg) { window.open(`https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(msg)}`); }
        function handleFileUIUpdate(input) { if (input.files && input.files[0]) { document.getElementById('cv-label-text').innerText = "Selected: " + input.files[0].name; document.getElementById('cv-hidden-val').value = "UPLOAD_ACTIVE"; } }

        async function handleApplicationSubmit(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            const app = {};
            f.forEach((v, k) => app[k] = v);
            const job = state.data.jobs.find(j => j.jobid === state.selectedId);
            app.appid = "APP-" + Date.now().toString().slice(-6);
            app.jobid = job.jobid;
            app.jobtitle = job.title;
            app.status = "New";
            app.applieddate = new Date().toISOString().split('T')[0];
            await submitDeskAction({ action: 'addApplication', application: app });
        }

        function openJobEditor(jobid = null) { alert("Mandate modification Desk active for " + (jobid || 'NEW ENTRY')); }

        function checkDeepLink() {
            const params = new URLSearchParams(window.location.search);
            const jid = params.get('jobid');
            const doApply = params.get('apply');
            if (jid) router.navigate('careers', doApply ? 'apply' : 'detail', jid);
        }

        window.onload = () => { renderNav(); fetchDeskData(); };
    </script>
</body>
</html>
