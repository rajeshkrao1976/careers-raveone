<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAVEONE ATS | V1.1 Unified Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --erp-bg: #F4F5F6;
            --erp-white: #FFFFFF;
            --erp-border: #D1D8DD;
            --erp-text: #1D2129;
            --erp-text-muted: #626161;
            --erp-blue: #1B68B3; 
            --erp-blue-hover: #15528E;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--erp-bg);
            color: var(--erp-text);
            font-size: 13px;
        }

        /* ERPNext Style Elements */
        .btn-erp {
            padding: 6px 12px;
            font-weight: 500;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-erp-primary { background-color: var(--erp-blue); color: white; border-color: var(--erp-blue); }
        .btn-erp-primary:hover { background-color: var(--erp-blue-hover); }
        .btn-erp-secondary { background-color: var(--erp-white); color: var(--erp-text); border-color: var(--erp-border); }
        .btn-erp-secondary:hover { background-color: #F8F9FA; border-color: #ADB5BD; }

        .erp-table { width: 100%; border-collapse: collapse; background: white; }
        .erp-table th { 
            background: #F8F9FA; 
            color: var(--erp-text-muted); 
            font-weight: 500; 
            text-align: left; 
            padding: 10px 15px; 
            border-bottom: 1px solid var(--erp-border);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }
        .erp-table td { padding: 10px 15px; border-bottom: 1px solid #EDF0F2; }
        .erp-table tr:hover { background-color: #F9FAFB; }

        .badge-erp {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid transparent;
        }
        .badge-active { background: #E6FFFA; color: #047481; border-color: #B2F5EA; }
        .badge-new { background: #EBF8FF; color: #2B6CB0; border-color: #BEE3F8; }
        .badge-warning { background: #FFFBEB; color: #B45309; border-color: #FDE68A; }

        input, select, textarea {
            border: 1px solid var(--erp-border) !important;
            border-radius: 4px !important;
            background: #F8F9FA;
            padding: 6px 10px !important;
            font-size: 13px;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--erp-blue) !important; outline: none; background: white; }

        .fade-in { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-label { font-size: 10px; font-weight: 700; color: var(--erp-text-muted); text-transform: uppercase; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="selection:bg-blue-100">

    <!-- TOP NAVIGATION -->
    <header id="top-bar" class="h-12 bg-white border-b sticky top-0 z-[150] flex items-center justify-between px-4 hidden">
        <div class="flex items-center gap-4 h-full">
            <div class="flex items-center gap-2 cursor-pointer font-bold text-gray-800" onclick="router.navigate('careers')">
                <div class="w-6 h-6 bg-gray-800 rounded flex items-center justify-center text-white text-[10px]">R</div>
                <span class="tracking-tight text-sm uppercase">Raveone ATS</span>
            </div>
            <nav id="admin-nav" class="flex h-full items-center gap-1">
                <!-- Nav items injected here -->
            </nav>
        </div>
        <div id="user-controls" class="flex items-center gap-3">
            <!-- Auth controls injected here -->
        </div>
    </header>

    <!-- PUBLIC HEADER -->
    <header id="public-header" class="h-14 bg-white border-b flex items-center justify-between px-6">
        <div class="flex items-center gap-2 cursor-pointer" onclick="router.navigate('careers')">
            <div class="w-8 h-8 bg-gray-800 rounded flex items-center justify-center font-bold text-white">R</div>
            <span class="font-bold tracking-tight text-lg">RAVEONE</span>
        </div>
        <button onclick="router.navigate('login')" class="btn-erp btn-erp-secondary">Recruiter Login</button>
    </header>

    <!-- PAGE HEADER SECTION -->
    <div id="page-context-header" class="bg-white border-b py-3 px-6 md:px-10 hidden">
        <div class="max-w-[1500px] mx-auto flex justify-between items-center">
            <div id="breadcrumb" class="flex items-center gap-2 text-[11px] text-gray-400 font-bold uppercase tracking-wider">
                <span class="hover:text-blue-600 cursor-pointer">ATS</span> <i data-lucide="chevron-right" class="w-3 h-3"></i> <span id="current-page-label" class="text-gray-800">Dashboard</span>
            </div>
            <div id="page-actions" class="flex gap-2"></div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="app-viewport" class="p-4 md:p-8 max-w-[1500px] w-full mx-auto flex-1 min-h-[calc(100vh-10rem)]">
        <!-- Views injected here -->
    </main>

    <!-- MODAL -->
    <div id="modal-container" class="fixed inset-0 bg-black/40 z-[300] items-center justify-center p-4 hidden backdrop-blur-[1px]">
        <div id="modal-content" class="bg-white w-full max-w-6xl rounded shadow-lg flex flex-col max-h-[95vh] overflow-hidden border">
            <!-- Modal data injected here -->
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="h-10 border-t bg-white flex items-center justify-between px-6 text-[11px] text-gray-400">
        <div class="flex gap-4 items-center">
            <span class="font-medium">© 2026 Raveone Consultants</span>
            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
            <span class="font-bold text-green-600 uppercase tracking-tighter">V1.1 Stable</span>
        </div>
    </footer>

    <script>
        // --- CONFIG ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbybXkJLimoas4lnPTmc0AA4JVVUkXZYcbBB84UQg52OiYO6Rs-p2B2XE2owJLR9Nw_w/exec";
        const apiKey = ""; // Provided by environment
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let state = {
            user: null,
            currentView: 'careers',
            loading: true,
            data: { jobs: [], applications: [], sourced: [], interviews: [], clients: [], billing: [] },
            selectedJob: null,
            subView: 'list',
            selectedItem: null 
        };

        // --- API HELPERS ---
        async function fetchData() {
            state.loading = true;
            renderViewport();
            try {
                const sheets = ['Jobs', 'Applications', 'Sourced', 'Interview Tracker', 'Clients', 'Dashboard and Billing'];
                const results = await Promise.all(
                    sheets.map(s => fetch(`${SCRIPT_URL}?action=getSheetData&sheetName=${encodeURIComponent(s)}`).then(r => r.json()))
                );
                state.data = {
                    jobs: results[0] || [],
                    applications: results[1] || [],
                    sourced: results[2] || [],
                    interviews: results[3] || [],
                    clients: results[4] || [],
                    billing: results[5] || []
                };
            } catch (err) { console.error("Fetch Error:", err); } 
            finally {
                state.loading = false;
                renderTopBar();
                renderViewport();
            }
        }

        async function postAction(payload) {
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.success) { closeModal(); await fetchData(); } 
                else { alert("Backend Error: " + result.error); }
            } catch (err) { alert("Network Connection Error"); }
        }

        async function generateAIJD(title, industry) {
            const prompt = `Create a professional and detailed Job Description for the role of ${title} in the ${industry} industry. Include sections for Job Summary, Key Responsibilities, Required Skills, Education, and Benefits. Keep it structured and suitable for a recruitment portal.`;
            try {
                const res = await fetch(GEMINI_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const json = await res.json();
                return json.candidates?.[0]?.content?.parts?.[0]?.text || "AI generation failed.";
            } catch (err) { return "AI connection failed."; }
        }

        // --- ROUTING ---
        const router = {
            navigate: (viewName, subViewName = 'list') => {
                state.currentView = viewName;
                state.subView = subViewName;
                renderTopBar();
                renderViewport();
                window.scrollTo(0,0);
            }
        };

        // --- UI RENDERERS ---
        function renderTopBar() {
            const topBar = document.getElementById('top-bar');
            const publicHeader = document.getElementById('public-header');
            const pageHeader = document.getElementById('page-context-header');
            const nav = document.getElementById('admin-nav');
            const controls = document.getElementById('user-controls');
            const pageLabel = document.getElementById('current-page-label');

            if (!state.user) {
                topBar.classList.add('hidden');
                pageHeader.classList.add('hidden');
                publicHeader.classList.remove('hidden');
                return;
            }

            topBar.classList.remove('hidden');
            pageHeader.classList.remove('hidden');
            publicHeader.classList.add('hidden');
            pageLabel.innerText = state.currentView;

            const menu = [
                { id: 'jobs', label: 'Requirements' },
                { id: 'applications', label: 'Candidates' },
                { id: 'sourced', label: 'Sourcing' },
                { id: 'interviews', label: 'Schedule' },
                { id: 'clients', label: 'Clients' },
                { id: 'billing', label: 'Accounting' },
                { id: 'marketing', label: 'Marketing' },
                { id: 'careers', label: 'Portal' }
            ];

            nav.innerHTML = menu.map(item => `
                <button onclick="router.navigate('${item.id}')" class="px-3 py-1.5 text-[11px] font-bold rounded hover:bg-gray-100 transition-colors uppercase ${state.currentView === item.id ? 'bg-gray-100 text-blue-700' : 'text-gray-500'}">
                    ${item.label}
                </button>
            `).join('');

            controls.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">${state.user.name}</span>
                    <button onclick="handleLogout()" class="text-gray-300 hover:text-red-500"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderViewport() {
            const viewport = document.getElementById('app-viewport');
            if (state.loading) {
                viewport.innerHTML = `<div class="h-64 flex flex-col items-center justify-center gap-3"><div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div></div>`;
                return;
            }
            switch(state.currentView) {
                case 'careers': viewCareers(); break;
                case 'login': viewLogin(); break;
                case 'jobs': viewJobs(); break;
                case 'applications': viewApplications(); break;
                case 'sourced': viewSourced(); break;
                case 'interviews': viewInterviews(); break;
                case 'clients': viewClients(); break;
                case 'billing': viewBilling(); break;
                case 'marketing': viewMarketing(); break;
                default: viewport.innerHTML = `<div class="p-20 text-center text-gray-300 uppercase">Coming Soon</div>`;
            }
            lucide.createIcons();
        }

        // --- JOBS VIEW (ALL 20+ FIELDS) ---
        function viewJobs() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold">Requirement Inventory (V1.1)</h2>
                        <button onclick="handleNewJob()" class="btn-erp btn-erp-primary">Create Requirement</button>
                    </div>
                    <div class="bg-white border rounded overflow-x-auto shadow-sm">
                        <table class="erp-table">
                            <thead>
                                <tr>
                                    <th>ID</th><th>Position</th><th>Client</th><th>Location</th><th>Exp</th><th>Salary</th><th>Industry</th><th>Status</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.data.jobs.map(j => `
                                    <tr>
                                        <td class="font-mono text-blue-600 font-bold text-[11px]">${j.jobid}</td>
                                        <td><div class="font-bold">${j.title}</div><div class="text-[10px] text-gray-400 uppercase font-bold">${j.employmenttype} • ${j.category}</div></td>
                                        <td class="text-xs font-bold uppercase text-gray-400">${j.company}</td>
                                        <td class="text-xs">${j.location}</td>
                                        <td class="text-xs font-bold text-gray-600">${j.minexperience}-${j.maxexperience} Yrs</td>
                                        <td class="text-xs font-bold text-green-700">₹ ${j.minsalary}-${j.maxsalary}</td>
                                        <td class="text-xs text-gray-500">${j.industry}</td>
                                        <td><span class="badge-erp ${j.status === 'Active' ? 'badge-active' : 'badge-warning'}">${j.status}</span></td>
                                        <td class="flex gap-2">
                                            <button onclick="handleEditJob('${j.jobid}')" class="text-blue-600 hover:underline font-bold text-[10px] uppercase">Details/Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- APPLICATIONS VIEW ---
        function viewApplications() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold">Talent Screening Pipeline</h2>
                    </div>
                    <div class="bg-white border rounded overflow-x-auto">
                        <table class="erp-table">
                            <thead>
                                <tr>
                                    <th>Candidate</th><th>Position</th><th>Exp / Edu</th><th>Financials</th><th>Status</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.data.applications.map(a => `
                                    <tr>
                                        <td>
                                            <p class="font-bold">${a.candidatename}</p>
                                            <p class="text-[10px] text-gray-400 font-bold uppercase">${a.email} • ${a.phone}</p>
                                        </td>
                                        <td>
                                            <p class="font-bold text-blue-700 text-xs">${a.jobid}</p>
                                            <p class="text-[10px] text-gray-400">${a.jobtitle}</p>
                                        </td>
                                        <td>
                                            <p class="text-[11px] font-bold text-gray-600">${a.totalexperience} Total / ${a.relevantexperience} Rel</p>
                                            <p class="text-[10px] text-gray-400 font-bold uppercase">${a.education}</p>
                                        </td>
                                        <td>
                                            <p class="text-[11px] font-bold text-gray-600">C: ${a.currentctc} → E: ${a.expectedctc}</p>
                                            <p class="text-[10px] text-orange-600 font-bold uppercase">Notice: ${a.noticeperiod} Days</p>
                                        </td>
                                        <td>
                                            <span class="badge-erp badge-new">${a.status}</span>
                                        </td>
                                        <td class="flex gap-3">
                                            <button onclick="viewCV('${a.resumelink}', '${a.candidatename}')" class="text-gray-400 hover:text-blue-600"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                            <a href="https://wa.me/${a.phone}" target="_blank" class="text-gray-400 hover:text-green-600"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- SOURCING VIEW ---
        function viewSourced() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-6 fade-in">
                    <h2 class="text-xl font-bold">External Sourcing Registry</h2>
                    <div class="bg-white border rounded overflow-hidden">
                        <table class="erp-table">
                            <thead>
                                <tr><th>Job ID</th><th>Client</th><th>Candidate</th><th>Source Details</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                ${state.data.sourced.map(s => `
                                    <tr>
                                        <td class="font-mono text-blue-600 font-bold">${s.jobid}</td>
                                        <td class="text-xs font-bold uppercase text-gray-400">${s.clientid}</td>
                                        <td class="font-bold">${s.candidatesourced}</td>
                                        <td class="text-xs">${s.sourcedemail} <br/> ${s.sourcedphone}</td>
                                        <td><button class="btn-erp btn-erp-secondary text-[10px]">Convert to App</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- INTERVIEWS VIEW ---
        function viewInterviews() {
            document.getElementById('app-viewport').innerHTML = `
                <div class="space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold">Interview Coordination Schedule</h2>
                        <button class="btn-erp btn-erp-primary">Schedule New Slot</button>
                    </div>
                    <div class="bg-white border rounded overflow-hidden">
                        <table class="erp-table">
                            <thead>
                                <tr><th>Date/Time</th><th>Candidate</th><th>Client</th><th>Mode</th><th>Status</th></tr>
                            </thead>
                            <tbody>
                                ${state.data.interviews.map(i => `
                                    <tr>
                                        <td><p class="font-bold text-blue-700">${i.interviewdate}</p><p class="text-[10px] text-gray-400 uppercase font-bold">${i.interviewtime}</p></td>
                                        <td class="font-bold">${i.candidatename}</td>
                                        <td class="text-xs font-bold uppercase text-gray-400">${i.companyname}</td>
                                        <td class="text-xs font-bold text-gray-600">${i.interviewmode}</td>
                                        <td><span class="badge-erp badge-active">${i.nextstep}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- CAREERS VIEW (PUBLIC) ---
        function viewCareers() {
            const viewport = document.getElementById('app-viewport');
            if (state.subView === 'list') {
                const activeJobs = state.data.jobs.filter(j => String(j.status).toLowerCase() === 'active');
                viewport.innerHTML = `
                    <div class="max-w-5xl mx-auto space-y-10 fade-in py-10">
                        <div class="text-center space-y-3">
                            <h1 class="text-4xl font-bold text-gray-900 tracking-tight">Careers @ Raveone Consultants</h1>
                            <p class="text-gray-500 font-medium">Explore active mandates from premium clients worldwide.</p>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            ${activeJobs.map(job => `
                                <div onclick="handleJobDetail('${job.jobid}')" class="bg-white border p-6 rounded flex justify-between items-center hover:border-blue-500 cursor-pointer group transition-all">
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800 group-hover:text-blue-700">${job.title}</h3>
                                        <p class="text-xs text-gray-400 font-bold uppercase tracking-tight">${job.company} • ${job.location} • ${job.industry}</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="text-[11px] font-bold text-gray-400 uppercase">${job.employmenttype}</span>
                                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-200 group-hover:text-blue-500"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (state.subView === 'detail' && state.selectedJob) {
                const j = state.selectedJob;
                viewport.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-6 fade-in py-10">
                        <button onclick="router.navigate('careers', 'list')" class="btn-erp btn-erp-secondary text-xs"><i data-lucide="arrow-left" class="w-3 h-3"></i> Listings</button>
                        <div class="bg-white border rounded p-10 space-y-8">
                            <div class="flex justify-between items-start border-b pb-8">
                                <div><h1 class="text-4xl font-bold text-gray-900">${j.title}</h1><p class="text-gray-500 font-bold uppercase text-xs mt-2">${j.company} | ${j.location}</p></div>
                                <button onclick="router.navigate('careers', 'apply')" class="btn-erp btn-erp-primary py-4 px-8">Submit Candidature</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                                <div class="md:col-span-2 space-y-8 text-gray-600 leading-relaxed text-sm">
                                    <section><h4 class="text-gray-900 font-bold text-xs uppercase mb-4 tracking-widest border-l-4 border-blue-600 pl-3">Role Overview</h4><div class="whitespace-pre-wrap">${j.description}</div></section>
                                    <section><h4 class="text-gray-900 font-bold text-xs uppercase mb-4 tracking-widest border-l-4 border-blue-600 pl-3">Technical Requirements</h4><div class="whitespace-pre-wrap">${j.requirements}</div></section>
                                    <section><h4 class="text-gray-900 font-bold text-xs uppercase mb-4 tracking-widest border-l-4 border-blue-600 pl-3">Benefits</h4><div class="whitespace-pre-wrap">${j.benefits}</div></section>
                                </div>
                                <div class="space-y-4">
                                    <div class="bg-gray-50 border p-5 rounded space-y-4">
                                        <h5 class="font-bold text-[10px] uppercase text-gray-400 tracking-widest border-b pb-2">Mandate Intelligence</h5>
                                        <div><p class="text-[9px] font-bold text-gray-400 uppercase">Employment Type</p><p class="font-bold text-sm">${j.employmenttype}</p></div>
                                        <div><p class="text-[9px] font-bold text-gray-400 uppercase">Min Education</p><p class="font-bold text-sm">${j.education}</p></div>
                                        <div><p class="text-[9px] font-bold text-gray-400 uppercase">Experience</p><p class="font-bold text-sm">${j.minexperience} - ${j.maxexperience} Yrs</p></div>
                                        <div><p class="text-[9px] font-bold text-gray-400 uppercase">Key Skills</p><p class="font-bold text-sm text-blue-700">${j.skills}</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.subView === 'apply' && state.selectedJob) {
                viewport.innerHTML = `
                    <div class="max-w-4xl mx-auto py-10 fade-in space-y-6">
                        <button onclick="router.navigate('careers', 'detail')" class="btn-erp btn-erp-secondary text-xs">Return to JD</button>
                        <div class="bg-white border p-8 rounded space-y-8">
                            <h3 class="text-xl font-bold border-b pb-4">Application Form: ${state.selectedJob.title}</h3>
                            <form id="apply-form" class="space-y-8" onsubmit="handleApplySubmit(event)">
                                <div class="form-grid">
                                    <div class="form-group"><label class="form-label">Full Name</label><input required name="candidatename" /></div>
                                    <div class="form-group"><label class="form-label">Email Address</label><input required type="email" name="email" /></div>
                                    <div class="form-group"><label class="form-label">Phone Number</label><input required name="phone" /></div>
                                    <div class="form-group"><label class="form-label">Highest Education</label><input required name="education" /></div>
                                    <div class="form-group"><label class="form-label">Total Exp (Yrs)</label><input required name="totalexperience" /></div>
                                    <div class="form-group"><label class="form-label">Rel Exp (Yrs)</label><input required name="relevantexperience" /></div>
                                    <div class="form-group"><label class="form-label">Current CTC (LPA)</label><input required name="currentctc" /></div>
                                    <div class="form-group"><label class="form-label">Expected CTC (LPA)</label><input required name="expectedctc" /></div>
                                    <div class="form-group"><label class="form-label">Notice Period (Days)</label><input required name="noticeperiod" /></div>
                                    <div class="form-group"><label class="form-label">Current Location</label><input required name="location" /></div>
                                </div>
                                <div class="space-y-4 p-6 bg-gray-50 border-2 border-dashed rounded-sm text-center">
                                    <div class="flex flex-col items-center">
                                        <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-300 mb-2"></i>
                                        <label class="form-label block mb-2">Resume Upload / Drive Link</label>
                                        <input required name="resumelink" placeholder="Paste Google Drive / Dropbox link here" />
                                        <p class="text-[10px] text-gray-400 mt-2">Ensure link permissions are set to 'Anyone with the link'</p>
                                    </div>
                                </div>
                                <div class="pt-4">
                                    <button type="submit" class="btn-erp btn-erp-primary w-full py-4 text-sm font-bold uppercase tracking-[0.2em]">Finalize & Submit Application</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }
        }

        // --- JOB MODAL (CREATE/EDIT WITH ALL 20 FIELDS) ---
        function openJobModal() {
            const j = state.selectedItem;
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <span class="text-xs font-bold uppercase tracking-widest">Mandate Definition: ${j.jobid || 'NEW'}</span>
                    <button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-6 overflow-y-auto space-y-8">
                    <div class="bg-blue-50/50 p-4 border border-blue-100 rounded-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-[11px] font-bold text-blue-700 uppercase tracking-widest">Primary Identity</h4>
                            <button onclick="handleAIGenFull()" class="btn-erp btn-erp-primary text-[10px] px-3"><i data-lucide="sparkles" class="w-3 h-3"></i> AI Generate JD</button>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Job ID</label><input id="mod-jobid" value="${j.jobid||''}" /></div>
                            <div class="form-group"><label class="form-label">Role Title</label><input id="mod-title" value="${j.title||''}" /></div>
                            <div class="form-group"><label class="form-label">Client Name</label><input id="mod-company" value="${j.company||''}" /></div>
                            <div class="form-group"><label class="form-label">Industry</label><input id="mod-industry" value="${j.industry||''}" /></div>
                            <div class="form-group"><label class="form-label">Location</label><input id="mod-location" value="${j.location||''}" /></div>
                            <div class="form-group"><label class="form-label">Category</label><input id="mod-category" value="${j.category||''}" /></div>
                            <div class="form-group"><label class="form-label">Employment Type</label><select id="mod-employmenttype"><option ${j.employmenttype==='Full Time'?'selected':''}>Full Time</option><option ${j.employmenttype==='Contract'?'selected':''}>Contract</option><option ${j.employmenttype==='Freelance'?'selected':''}>Freelance</option></select></div>
                            <div class="form-group"><label class="form-label">Status</label><select id="mod-status"><option ${j.status==='Active'?'selected':''}>Active</option><option ${j.status==='Inactive'?'selected':''}>Inactive</option></select></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div class="form-group"><label class="form-label">Job Description</label><textarea id="mod-description" class="h-48">${j.description||''}</textarea></div>
                            <div class="form-group"><label class="form-label">Requirements</label><textarea id="mod-requirements" class="h-32">${j.requirements||''}</textarea></div>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 border rounded-sm">
                                <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 border-b pb-1">Mandate Specifications</h4>
                                <div class="form-grid">
                                    <div class="form-group"><label class="form-label">Min Exp</label><input id="mod-minexperience" value="${j.minexperience||''}" /></div>
                                    <div class="form-group"><label class="form-label">Max Exp</label><input id="mod-maxexperience" value="${j.maxexperience||''}" /></div>
                                    <div class="form-group"><label class="form-label">Min Salary (LPA)</label><input id="mod-minsalary" value="${j.minsalary||''}" /></div>
                                    <div class="form-group"><label class="form-label">Max Salary (LPA)</label><input id="mod-maxsalary" value="${j.maxsalary||''}" /></div>
                                    <div class="form-group"><label class="form-label">Education</label><input id="mod-education" value="${j.education||''}" /></div>
                                    <div class="form-group"><label class="form-label">Positions</label><input id="mod-numberofpositions" value="${j.numberofpositions||''}" /></div>
                                </div>
                            </div>
                            <div class="form-group"><label class="form-label">Key Skills (Comma separated)</label><input id="mod-skills" value="${j.skills||''}" /></div>
                            <div class="form-group"><label class="form-label">Benefits</label><textarea id="mod-benefits" class="h-24">${j.benefits||''}</textarea></div>
                            <div class="form-group"><label class="form-label">Job URL (External)</label><input id="mod-joburl" value="${j.joburl||''}" /></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end gap-2 bg-gray-50">
                    <button onclick="closeModal()" class="btn-erp btn-erp-secondary">Discard</button>
                    <button onclick="saveJobModal()" class="btn-erp btn-erp-primary">Sync with Backend</button>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById('modal-container').classList.add('flex');
            lucide.createIcons();
        }

        async function handleAIGenFull() {
            const title = document.getElementById('mod-title').value;
            const industry = document.getElementById('mod-industry').value;
            if (!title) return alert("Please specify Role Title first.");
            document.getElementById('mod-description').value = "Generating Mandate Profile with Gemini AI...";
            const res = await generateAIJD(title, industry);
            document.getElementById('mod-description').value = res;
        }

        function saveJobModal() {
            const job = {
                jobid: document.getElementById('mod-jobid').value,
                title: document.getElementById('mod-title').value,
                company: document.getElementById('mod-company').value,
                industry: document.getElementById('mod-industry').value,
                location: document.getElementById('mod-location').value,
                category: document.getElementById('mod-category').value,
                employmenttype: document.getElementById('mod-employmenttype').value,
                status: document.getElementById('mod-status').value,
                description: document.getElementById('mod-description').value,
                requirements: document.getElementById('mod-requirements').value,
                minexperience: document.getElementById('mod-minexperience').value,
                maxexperience: document.getElementById('mod-maxexperience').value,
                minsalary: document.getElementById('mod-minsalary').value,
                maxsalary: document.getElementById('mod-maxsalary').value,
                education: document.getElementById('mod-education').value,
                numberofpositions: document.getElementById('mod-numberofpositions').value,
                skills: document.getElementById('mod-skills').value,
                benefits: document.getElementById('mod-benefits').value,
                joburl: document.getElementById('mod-joburl').value,
                posteddate: new Date().toISOString().split('T')[0]
            };
            postAction({ action: 'updateJob', job });
        }

        function handleApplySubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const application = {};
            formData.forEach((v, k) => application[k] = v);
            application.jobid = state.selectedJob.jobid;
            application.jobtitle = state.selectedJob.title;
            application.status = 'New';
            application.applieddate = new Date().toISOString().split('T')[0];
            application.appid = `APP-${Date.now().toString().slice(-6)}`;
            postAction({ action: 'addApplication', application });
        }

        // --- HANDLERS ---
        function handleLoginSubmit(e) {
            e.preventDefault();
            if (document.getElementById('login-email').value === 'rajesh@raveone.in' && document.getElementById('login-pass').value === 'P1@st15s!') {
                state.user = { name: 'Rajesh K Rao' };
                router.navigate('jobs');
            } else alert("Invalid Recruiter Credentials");
        }

        function handleLogout() { state.user = null; router.navigate('careers'); }
        function handleJobDetail(id) { state.selectedJob = state.data.jobs.find(j => j.jobid === id); router.navigate('careers', 'detail'); }
        function handleNewJob() { state.selectedItem = {}; openJobModal(); }
        function handleEditJob(id) { state.selectedItem = state.data.jobs.find(j => j.jobid === id); openJobModal(); }
        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }

        // Reuse client drill down from context
        function handleClientDrill(id) {
            const client = state.data.clients.find(c => c.clientid === id);
            const jobs = state.data.jobs.filter(j => j.company === client.companyname);
            const viewport = document.getElementById('client-drill-viewport');
            viewport.innerHTML = `
                <div class="w-full space-y-6 fade-in">
                    <div class="border-b pb-3 flex justify-between items-center"><h4 class="font-bold text-blue-700 uppercase">${client.companyname} Mandates</h4><button onclick="viewClients()"><i data-lucide="x" class="w-4 h-4 text-gray-300"></i></button></div>
                    <div class="space-y-2 overflow-y-auto max-h-[500px]">
                        ${jobs.map(j => `
                            <div class="p-4 bg-gray-50 border-l-2 border-blue-600 rounded">
                                <p class="text-xs font-bold text-gray-800">${j.title}</p>
                                <div class="flex gap-4 mt-2">
                                    <span class="text-[9px] font-bold text-gray-400 uppercase">${state.data.applications.filter(a=>a.jobid===j.jobid).length} Apps</span>
                                    <span class="text-[9px] font-bold text-gray-400 uppercase">${state.data.interviews.filter(i=>i.companyname===client.companyname && i.positiontitle===j.title).length} Ints</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        async function generateMkt(mode) {
            const roleId = document.getElementById('mkt-role').value;
            if (!roleId) return alert("Select a role");
            const job = state.data.jobs.find(j => j.jobid === roleId);
            const preview = document.getElementById('mkt-preview');
            preview.innerHTML = `<span class="animate-pulse text-gray-400 font-bold text-xs uppercase">AI Architecting Content...</span>`;
            const content = await generateAIJD(job.title, job.industry);
            preview.innerHTML = `<textarea class="w-full h-full bg-transparent border-none text-xs text-gray-600 p-2 leading-relaxed" readonly>${content}</textarea><button onclick="navigator.clipboard.writeText(\`${content}\`); alert('Copied to clipboard');" class="btn-erp btn-erp-secondary text-[10px] absolute bottom-4 right-4">Copy Pitch</button>`;
        }

        function viewCV(link, name) {
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            content.innerHTML = `<div class="p-3 border-b flex justify-between items-center bg-gray-50"><span class="text-xs font-bold text-gray-600 uppercase">CV Vault: ${name}</span><button onclick="closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button></div><iframe src="${link}" class="flex-1 w-full border-none h-[85vh]"></iframe>`;
            container.classList.remove('hidden'); container.classList.add('flex'); lucide.createIcons();
        }

        function copyAppPitch(id) {
            const a = state.data.applications.find(ap => ap.appid === id);
            const pitch = `Pitching Candidate: ${a.candidatename}\nPosition: ${a.jobtitle}\nExp: ${a.totalexperience} Yrs\nRel Exp: ${a.relevantexperience} Yrs\nCTC: ${a.currentctc} LPA\nNotice: ${a.noticeperiod} Days\nCV: ${a.resumelink}`;
            navigator.clipboard.writeText(pitch); alert("Pitch template copied!");
        }

        function shareJob(id, mode) {
            const j = state.data.jobs.find(job => job.jobid === id);
            const msg = `Mandate: ${j.title} @ ${j.company}\nLoc: ${j.location}\nExp: ${j.minexperience}+ Yrs\nLink: https://raveone.in/careers?jobid=${id}`;
            if (mode === 'WA') window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
            else { navigator.clipboard.writeText(msg); alert("Job capsule copied!"); }
        }

        window.onload = fetchData;
    </script>
</body>
</html>
